<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Pythonic Perambulations]]></title>
  <link href="http://jakevdp.github.com/atom.xml" rel="self"/>
  <link href="http://jakevdp.github.com/"/>
  <updated>2012-10-05T08:21:16-07:00</updated>
  <id>http://jakevdp.github.com/</id>
  <author>
    <name><![CDATA[Jake Vanderplas]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Blogging with IPython in Octopress]]></title>
    <link href="http://jakevdp.github.com/blog/2012/10/04/blogging-with-ipython/"/>
    <updated>2012-10-04T18:40:00-07:00</updated>
    <id>http://jakevdp.github.com/blog/2012/10/04/blogging-with-ipython</id>
    <content type="html"><![CDATA[<div class="ipynb">

<div class="text_cell_render border-box-sizing rendered_html">
<p>A few weeks ago, Fernando Perez, the creator of IPython, wrote a <a href="http://blog.fperez.org/2012/09/blogging-with-ipython-notebook.html">post</a> about blogging with IPython notebooks.  I decided to take a stab at making this work in Octopress.</p>
<p>I started by following Fernando&#8217;s outline:  I first went to <a href="http://github.com/ipython/nbconvert">http://github.com/ipython/nbconvert</a> and obtained the current version of the notebook converter.  Running <code>nbconvert.py -f blogger-html filename.ipynb</code> produces a separate html and header file with the notebook content.  I inserted the stylesheet info into my header (in octopress, the default location is <code>source/_includes/custom/head.html</code>) and copied the html directly into my post.</p>
<p>I immediately encountered a problem.  <code>nbconvert</code> uses global CSS classes and style markups, and some of these (notably the &#8220;hightlight&#8221; class and the <code>&lt;pre&gt;</code> tag formatting) conflict with styles defined in my octopress theme.  The result was that every post in my blog ended up looking like an ugly hybrid of octopress and an ipython notebook.  Not very nice.</p>
<p>So I did some surgery.  Admittedly, this is a terrible hack, but the following code takes the files output by nbconvert, slices them up, and creates a specific set of CSS classes for the notebook markup, such that there&#8217;s no longer a conflict with the native octopress styles
(you can download this script <a href="http://jakevdp.github.com/downloads/code/convert_notebook.py">here</a>):</p>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In [&nbsp;]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="c">#!/usr/bin/python</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">nbconvert</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">notebook</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;usage: python octopress_notebook.py  /path/to/nbconvert.py  /path/to/notebook_file.ipynb&quot;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="c"># convert notebook</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> -f blogger-html </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nbconvert</span><span class="p">,</span> <span class="n">notebook</span><span class="p">))</span>

<span class="c"># get out filenames</span>
<span class="n">outfile_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">notebook</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">body_file</span> <span class="o">=</span> <span class="n">outfile_root</span> <span class="o">+</span> <span class="s">&#39;.html&#39;</span>
<span class="n">header_file</span> <span class="o">=</span> <span class="n">outfile_root</span> <span class="o">+</span> <span class="s">&#39;_header.html&#39;</span>


<span class="c"># read the files</span>
<span class="n">body</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">body_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">header</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">header_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>


<span class="c"># replace the highlight tags</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;class=&quot;highlight&quot;&#39;</span><span class="p">,</span> <span class="s">&#39;class=&quot;highlight-ipynb&quot;&#39;</span><span class="p">)</span>
<span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;highlight&#39;</span><span class="p">,</span> <span class="s">&#39;highlight-ipynb&#39;</span><span class="p">)</span>


<span class="c"># specify &lt;pre&gt; tags</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&lt;pre&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;pre class=&quot;ipynb&quot;&#39;</span><span class="p">)</span>
<span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;html, body&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s">&#39;pre.ipynb {&#39;</span><span class="p">,</span>
                                                 <span class="s">&#39;  color: black;&#39;</span><span class="p">,</span>
                                                 <span class="s">&#39;  background: #f7f7f7;&#39;</span><span class="p">,</span>
                                                 <span class="s">&#39;  border: 0;&#39;</span><span class="p">,</span>
                                                 <span class="s">&#39;  box-shadow: none;&#39;</span><span class="p">,</span>
                                                 <span class="s">&#39;  margin-bottom: 0;&#39;</span><span class="p">,</span>
                                                 <span class="s">&#39;  padding: 0;&#39;</span>
                                                 <span class="s">&#39;}</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span>
                                                 <span class="s">&#39;html, body&#39;</span><span class="p">)))</span>


<span class="c"># create a special div for notebook</span>
<span class="n">body</span> <span class="o">=</span> <span class="s">&#39;&lt;div class=&quot;ipynb&quot;&gt;</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">body</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&lt;/div&gt;&quot;</span>
<span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;body {&#39;</span><span class="p">,</span> <span class="s">&#39;div.ipynb {&#39;</span><span class="p">)</span>


<span class="c"># specialize headers</span>
<span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;html, body,&#39;</span><span class="p">,</span>
                        <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(((</span><span class="s">&#39;h1.ipynb h2.ipynb h3.ipynb &#39;</span>
                                    <span class="s">&#39;h4.ipynb h5.ipynb h6.ipynb {&#39;</span><span class="p">),</span>
                                   <span class="s">&#39;h1.ipynb h2.ipynb ... {&#39;</span><span class="p">,</span>
                                   <span class="s">&#39;  margin: 0;&#39;</span><span class="p">,</span>
                                   <span class="s">&#39;  padding: 0;&#39;</span><span class="p">,</span>
                                   <span class="s">&#39;  border: 0;&#39;</span><span class="p">,</span>
                                   <span class="s">&#39;  font-size: 100%;&#39;</span><span class="p">,</span>
                                   <span class="s">&#39;  font: inherit;&#39;</span><span class="p">,</span>
                                   <span class="s">&#39;  vertical-align: baseline;&#39;</span><span class="p">,</span>
                                   <span class="s">&#39;}</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span>
                                   <span class="s">&#39;html, body,&#39;</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="s">&#39;123456&#39;</span><span class="p">:</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&lt;h</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">h</span><span class="p">,</span> <span class="s">&#39;&lt;h</span><span class="si">%s</span><span class="s"> class=&quot;ipynb&quot;&#39;</span> <span class="o">%</span> <span class="n">h</span><span class="p">)</span>


<span class="c"># comment out document-level formatting</span>
<span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;html, body,&#39;</span><span class="p">,</span>
                        <span class="s">&#39;/*html, body,*/&#39;</span><span class="p">)</span>
<span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;h1, h2, h3, h4, h5, h6,&#39;</span><span class="p">,</span>
                        <span class="s">&#39;/*h1, h2, h3, h4, h5, h6,*/&#39;</span><span class="p">)</span>

<span class="c">#----------------------------------------------------------------------</span>
<span class="c"># Write the results to file</span>
<span class="nb">open</span><span class="p">(</span><span class="n">body_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
<span class="nb">open</span><span class="p">(</span><span class="n">header_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>This code should be run with two arguments: first the file to be converted, then the path to <code>nbconvert.py</code>.  Like the native <code>nbconvert.py</code> this produces a separate file of header code (which is inserted once into the  master blog header) and body code which can be copied verbatim into the post.</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<h2 class="ipynb">
  Trying it out
</h2>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you haven&#8217;t noticed already, this post is written entirely in an IPython notebook.  So let&#8217;s see how some things look.</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>First of all, we can write some math, which is rendered using mathjax:</p>
<p>$f(x) = \int_0^\infty \left(\frac{\sin(x)}{x^2}\right)dx$</p>
<p>As we see, it renders nicely.</p>
<p>Or we can do some inline plotting:</p>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In [1]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%</span><span class="k">pylab</span> <span class="n">inline</span>
</pre></div>

</div>
</div>
<div class="vbox output_wrapper">
<div class="output vbox">
<div class="hbox output_area">
<div class="prompt output_prompt"></div>
<div class="output_subarea output_stream output_stdout">
<pre class="ipynb">
Welcome to pylab, a matplotlib-based Python environment [backend: module://IPython.zmq.pylab.backend_inline].
For more information, type &apos;help(pylab)&apos;.
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In [2]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>

</div>
</div>
<div class="vbox output_wrapper">
<div class="output vbox">
<div class="hbox output_area">
<div class="prompt output_prompt">Out [2]:</div>
<div class="output_subarea output_pyout">
<pre class="ipynb">[&lt;matplotlib.lines.Line2D at 0x2cdba90&gt;]</pre>
</div>
</div>
<div class="hbox output_area">
<div class="prompt output_prompt"></div>
<div class="output_subarea output_display_data">
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAX0AAAD9CAYAAABQvqc9AAAABHNCSVQICAgIfAhkiAAAAAlwSFlz
AAALEgAACxIB0t1+/AAAIABJREFUeJzt3XlYVdX6B/DvUchSc0zQACUFBZwNMzWTQjRREcRUyjRt
sMG6eS1/3e7vuVdv5U8fu5Vdy6x7LS3nCTGR1Aw1lUjFIbXEAWVQKqcknMD9++O9OKIezjn7rD18
P8/DY+ph71c6vKz9rrXe5dA0TQMREdlCJdUBEBGR9zDpExHZCJM+EZGNMOkTEdkIkz4RkY0w6RMR
2YhbSX/48OHw9/dHy5Ytb/ial19+GaGhoWjdujWysrLcuR0REbnJraQ/bNgwpKWl3fDvU1NTsW/f
PmRnZ+OTTz7B888/787tiIjITW4l/S5duqB27do3/PuUlBQMHToUANChQwecPHkShYWF7tySiIjc
4KPnxfPz8xEUFHTp94GBgcjLy4O/v/9Vr3M4HHqGQURkWRVtqqD7RO61Ad0owWuaZsqPb77R0L27
hpo1NTzxhIZFizR8+62G9es1fPedhkmTNHTsqKFWLQ3PP6/h+PGbX+/vf/+78n+TUT74tbDP1yI3
V8Mbb2jw85Pvp48/1rB0qYZNmzRkZWmYNk1DUpIGf38N99zzd/z4o/qYjfDhCl1H+gEBAcjNzb30
+7y8PAQEBOh5S68pLgb+53+A5GTg//4PWLIEqFr1+td17gy8+ipQUAC8/TbQogXw4YdAfLz3YyYy
otmzgT/9CXjsMWDdOqBZs+tf06YN8OyzQEkJEBcHPPQQkJQEjB0L3KTCTOXQdaQfFxeHmTNnAgAy
MjJQq1at60o7ZvT990DbtsCJE8COHcDgweUn/Cvdfbck+zlzgDFjgIEDgaIi78RLZERnzkgiHzsW
WL0amDy5/IR/JR8f4L77gN27gXPn5IfB7t1eCdcy3BrpJyUlYe3atfjtt98QFBSEcePG4cKFCwCA
ESNGIDY2FqmpqQgJCUG1atXw2WefeSRolVaulCT/0UdA//4V//wHHwS2bwdeeAF45BEgNRWoUePy
30dFRXksVrPj1+Iyq30tCgqAnj2BiAhgyxbgzjud/9yoqCjcdRfw8cfAl18CDz8sT9odO+oXr5U4
NFcLQ54MwuFwuT7lTatXyyNocjLQqZN717p4EXjxRWDbNmDFCqBWLc/ESGR0x47J4CcpCfjrXwF3
13GsWAEMHQrMmCE/SOzEldzJpO+kNWuAQYOAxYuBBx7wzDU1DXjlFWDDBnmCqFPHM9clMqqiIiA6
GujaFZg40f2EX2bTJpkn+/JLICbGM9c0AyZ9nWzeDMTGAgsXygjFkzQN+POfpeSzcqXULIms6Nw5
oFcvIDgY+PRTzyX8MmvXAgMGABs3Ak2aePbaRsWkr4MTJ4B77wUmTQISE/W5R2mp1PfbtwfGj9fn
HkSqDRsGnD4NzJsHVK6szz0++kg+Nm2q2DyBWTHpe5imAQkJQKNGsrJAT7/+Kj9cpkyRJWlEVjJn
jqzS2boVqFZNv/toGjBihHw/LVoEVLJ4S0kmfQ97911g7lzgu++A227T/34ZGZLwN22yz+MpWd/B
g0CHDkBaGtCunf73O39eVvTExgJvvKH//VRi0vegsgScmSk1SG+ZMgWYPl32Avj6eu++RHooKZF5
sMREYPRo7903N1d+wKxdK8tCrcqV3Gnxhx/XnDsnS8CmTvVuwgdkGedddwHvv+/d+xLp4R//kNr6
qFHevW9QEPDmm8Dw4TJnRpdxpF+Ot96SEX5Kipr7798vj8ObN3v/hw6Rp+zcKcszt28HGjTw/v0v
XpR2DfHx3v+h4y0s73hAWcLdskUmcFUZP17W73/1leeXthHpTdMk4Q4YILvPVcnOlp26mZlA48bq
4tALyztu0jRg5EjgtdfUJnxAmrQdOiR7A4jMZt484NQpWUmjUmioNEZ89ln5/iYm/assWiQTQH/+
s+pIZLXQtGmyY/fUKdXREDmvqEgGLVOm6LcevyJGjQKOHpWnZmJ555LiYunwN3s20KWL0lCuMny4
1EPfflt1JETO+ctfgPx84L8Ndg1h+XL5QbRzp7V2vbOm74ZJk2SZpNHKKYcPSxvnH39UMxlGVBHZ
2dKMcMcOY71fNU3W7iclSanHKpj0XXTqlNT+0tONuaZ39Gjg7Fnpx09kZI8/DjRvbsxNUZs3y96b
vXuB6tVVR+MZTPou+vvfZdL088+VhXBTv/0GhIXJkwh36pJR7d4tK3b27TNu35vHHpPvpb/9TXUk
nsGk74Jff5U3webNwD33KAnBKW++Cfz0EzBrlupIiMo3cCAQGSmr34zq4EGJcdcuoH591dG4j0nf
BWYpnRQVSQkqLQ1o3Vp1NERX27ED6NFDRvl6NlTzhJdfBqpUkXk8s2PSr6C8PKBVK/mpb6RJpxv5
4AM5zCU5WXUkRFfr109WvZlh52turpytm51t/oOLmPQraNQoab36z396/dYuKS6WElR6OhAerjoa
IrF1K9Cnj4zy77hDdTTOeeop2YBp9to+k34FnDghk6I7dgCBgV69tVvefFPqktOnq46ESCQkyATu
yy+rjsR5e/fKsacHDph7JQ+TfgWMHy//4426YudGjh8HQkLM98OKrCk7G+jcGcjJAapWVR1NxQwc
KH22jLAD31VM+k46e1a6V65eDbRo4bXbesyoUbK9/Z13VEdCdvfCC0DduvIEajbbtsmZvQcOyMSu
GTHpO+mTT4ClS2VrthmVTUTt2wfUrq06GrKrY8dkRdnu3eZd/tirl2zYUt0YzlXssumE0lKZuB0z
RnUkrgsKAnr3lkNeiFSZOlXq+WZN+IB04HzvPem9bxe2S/opKUDNmnKEm5mNGSNLOM+dUx0J2VHZ
3hYzLNG8mS5dgNtvB1atUh2J99gu6f/zn7Jj0OwHkzRvLnsMFixQHQnZ0ezZsknQjHNiV3I4gJde
Av71L9WReI+tavrbt0sNLyfHGu1Vly4FJkwANm1SHQnZiaYBLVtKWSQmRnU07jtzBmjYEMjIMF9v
K9b0b2HqVGmraoWED0hdv6BANscQeUt6uvzarZvSMDzmjjvk3Aqjt2LxFNuM9H//XXbg7doF3H23
rrfyqvHj5Vzf//xHdSRkF4MGycamkSNVR+I5hw4B7drJr2barMUlmzfx4YfA2rXA/Pm63sbrfvlF
Tvw6cIDLN0l/hYXSlTYnRxZEWElCgjSNe+451ZE4j+WdG9A04KOPZCOJ1fj5yTzFZ5+pjoTs4LPP
gMRE6yV84PKErvphsL5skfTXrZP/kV27qo5EHy++KD/U7LTWmLzv4kVg2jTzbmS6lYcekn/jhg2q
I9GXLZJ+2Sjf7Ms0b+T++4EaNYCVK1VHQla2cqW0Io6MVB2JPhwO6b5p9fkxy9f0rVyDvNLHHwPf
fMN1+6Sf+HgpJT7zjOpI9PPLL0DTpsDhwzKQMjrW9MvxxRfyZrVywgdkRcWqVXKeLpGn5eVJmTQp
SXUk+vLzA6KjgblzVUeiH0snfU2Tiadhw1RHor9atWTd/uzZqiMhK/rsM2lFbKbljK566ing3/9W
HYV+LJ30f/hBetN06aI6Eu8YPlzqkeoLdmQlmibnTgwfrjoS7+jRAzhyBNi5U3Uk+rB00v/sM+DJ
J607gXutqCjZhJaVpToSspLvvpOmZFadwL1W5cqSN6w6oWvZidwzZ+RkqW3bpBWxXYwbB/z6KzBl
iupIyCqeflomN83cjryiDhyQU7Xy8ox9wAoncq+QnAzce6+9Ej4gI5Q5c6T1LZG7iouBRYuAwYNV
R+JdjRtLF9HkZNWReJ5lk75dJnCv1aiR9BBZulR1JGQFS5bIPhAr9aty1pNPAjNnqo7C8yyZ9A8f
BrZskaWadjR8ODB9uuooyAo+/1ySnx3Fx8vu3F9+UR2JZ1ky6X/xBTBggLRMtaO+fYHMTODoUdWR
kJnl5krb7r59VUeiRvXqsgx63jzVkXiW5ZK+pgFffgk88YTqSNSpWlUOe7byBhPS3xdfAI8+Kit3
7OqJJySfWInlkv727TKJ2bGj6kjUevxxYNYs1VGQWWma1LOHDFEdiVrR0dJj/+efVUfiOZZL+rNm
yVZxu6zNv5GHH5blZnv3qo6EzCgrCzh/noMnHx/JJ1YaQFkq6V+8KMsVH39cdSTq+fjItnkrvVnJ
e+bM4eCpzODBUuJRv6PJM9xO+mlpaQgLC0NoaCgmTpx43d+np6ejZs2aaNu2Ldq2bYu33nrL3Vve
0Pr1QN26QPPmut3CVMpKPFZ5s5J3XLwo80FWb67mrHbtZF5j40bVkXiGW0eEl5aWYuTIkVi9ejUC
AgLQvn17xMXFITw8/KrXde3aFSkpKW4F6oxZszjKv1JkJFCpkqzk6dBBdTRkFt99J0dvtmihOhJj
cDguj/Y7d1YdjfvcSvqZmZkICQlBcHAwAGDQoEFYunTpdUnfmW3CY8eOvfTfUVFRiIqKqlAs587J
zkH2nbnM4bg82mfSJ2eVlXbosscek0HUBx8Avr7q4khPT0d6erpb13Ar6efn5yPoij4HgYGB+P77
7696jcPhwMaNG9G6dWsEBATgnXfeQURExHXXujLpuyItTUYmDRu6dRnLefxxGZ28+67U+Ylu5sIF
YOFCeTqky4KDgZAQOajokUfUxXHtgHjcuHEVvoZbNX2HE7M87dq1Q25uLrZv346XXnoJ8Tptk509
W34a09VCQuQNu2aN6kjIDFavBkJDgXvuUR2J8QwcaI2NWm4l/YCAAOTm5l76fW5uLgIDA696zZ13
3omqVasCAHr27IkLFy7g+PHj7tz2OkVFMtLv39+jl7WMAQN4jCI5Z/ZslnZu5NFHpafV+fOqI3GP
W0k/MjIS2dnZyMnJwfnz5zFv3jzExcVd9ZrCwsJLNf3MzExomoY6deq4c9vrLF8u64nr1vXoZS2j
f39pnHXhgupIyMiKi4Fly2SQQNcLDJSVgStXqo7EPW5VeX18fDBlyhT06NEDpaWleOqppxAeHo5p
06YBAEaMGIGFCxdi6tSp8PHxQdWqVTFXh94ACxbwjXozjRrJI/uaNXIqEFF5VqyQyUp/f9WRGFdZ
iad3b9WRuM70h6gUFQEBAcDBg4CHHyAs5b33gB9/tO5pQOS+QYNkJ/ezz6qOxLiOHAEiIuRXI/Qk
suUhKsuXA506MeHfSv/+ciCE2euRpI8zZ2RezK7tyJ3VoAHQpo08FZmV6ZP+ggUywUI3FxQEhIXJ
kjOia6WlyUlzfn6qIzG+gQOB+fNVR+E6Uyf9oiJg1SqOTpw1YIC536ykHw6enJeYKCP94mLVkbjG
1EmfpZ2K6d/fGkvOyLPOngVSU4GEBNWRmEO9ekD79uYt8Zg66c+fz1U7FREQIEvOVq1SHQkZyddf
A23bctVORSQmStsXMzJt0i8qkt2Ddj3KzVWPPsqNWnQ1lnYqLj5eRvrnzqmOpOJMm/RTU1nacUVC
AvDVV9yoReLcOSmT9uunOhJzqV8faNnSnE/Npk36ixfLIxZVTFAQ0KQJsG6d6kjICFauBFq1kiRG
FWPWEo8pk/7Zs7LE7JqOD+Skfv3M+WYlz1u4kD2rXNWvn7StMNtTsymT/urVskGCa4pdk5AgvXgu
XlQdCal04YKU+rhqxzVBQUDjxsDataojqRhTJv3Fi/lGdUfTpsBddwEZGaojIZXWrpXW29c0xqUK
MGOJx3RJv6QESElh0ndXv37yw5Psa8kSfh+5KzFRvo6lpaojcZ7pkv66dXLAA0/Ick9ioiR99e32
SIWLF6UXE5O+e0JCZH+DmQ5NN13SX7yYy8s8oWVLOTR92zbVkZAKmZlArVpAs2aqIzE/s5V4TJX0
L16URykmffc5HCzx2BlLO56TkCDtTczy1GyqpM/RiWdx6aY9aRoXQ3hSixby1Lxjh+pInGOqpM/S
jmfddx9w8iSwd6/qSMibdu2Spnvt2qmOxBocDmnLkJysOhLnmCbpa5o8krKNsudUqiQb3JYuVR0J
eVNZacfhUB2JdTDp62DPHtmJy9GJZ8XHM+nbDUs7ntepE5CfD+TkqI7k1kyT9JculY6aHJ141kMP
ydm5hYWqIyFvyMkB8vKAzp1VR2ItlSsDffqYYwBlmqSfnMw2ynqoUgXo0UO245P1paQAvXoBPj6q
I7GehARzlHhMkfQLCmSysWtX1ZFYU9++5nizkvvKnpjJ86Kjgaws4Ngx1ZHcnCmS/rJlQM+ewG23
qY7EmmJjpQ9LUZHqSEhPJ04AP/wAdO+uOhJruuMOoFs34z81myLpJydz1Y6eatUCOnSQ3upkXamp
8rRcrZrqSKzLDKt4DJ/0T58GNmwAHnlEdSTWZoY3K7mHpR399eoFrFkDFBerjuTGDJ/009JkOVSN
Gqojsba4ODk2r6REdSSkh3Pn5EmuTx/VkVhb7drAvfcC33yjOpIbM3zSZ2nHO4KCpHvp+vWqIyE9
pKcDERHSEZL0FRcnq6SMytBJ/8IFOXGexyJ6R1ycTJqT9bC04z19+sj3kVFPpjN00l+/XvpV3323
6kjsoWyEYpZugeQcTZP/r0z63tGkiZxMl5mpOpLyGTrpp6RwlO9NrVtLI649e1RHQp60ZYus2AkL
Ux2JffTta9wSj2GTftnohBNP3uNwGL8eSRXHwZP3Gfn7yLBJf/duOXeyVSvVkdiLkd+s5Bomfe9r
3x747Tdg/37VkVzPsEm/7I3KBmve1bWr/MBlAzZrOHxYGqx17Kg6EnupVOnyhK7RGD7pk3dVqSLb
9JcvVx0JecJXX0mbDTZY8z6jPjUbMukXFspkIhusqcGlm9bBwZM60dHA5s3A8eOqI7maIZP+8uUy
2mSDNTViY2Ur+ZkzqiMhd5w+DWzcyAZrqlStKudVrFihOpKrGTLpc3SiVp06QNu2kvjJvFaulFo+
W5ioY8S6vuGS/pkzkmxiY1VHYm9mOQWIbmzZMi55Vq1XL+Drr6W7gFEYLumvWSPn4NapozoSe+vT
RyYBjbqVnG6utFTKpEz6ajVoAISGGqunleGSfkoK0Lu36iioaVPgzjuBrVtVR0KuyMiQ9iWNGqmO
hIxW4jFU0tc0GV1ydGIMRnuzkvNY2jGOPn2M1dPKUEk/K0t6hDRrpjoSApj0zYwtTIyjdWup6Rul
p5Whkj5HJ8bSuTNw6JDs6CTz2L9f1oa3b686EgKkq4CRBlBM+nRDPj5yTKXRD3qmqy1bJqtGKhnq
u9vemPTLUVAAHDggo0syDiO9Wck5nBcznqgoYOdOacKmmmGS/ldfyajS11d1JHSlRx6R5WZ//KE6
EnLGqVNyeEdMjOpI6Eq33y5tGVJTVUfigaSflpaGsLAwhIaGYuLEieW+5uWXX0ZoaChat26NrKys
cl/D0o4x1aoFREYa+6Bnuuzrr4EHHpAFEWQsRnlqdivpl5aWYuTIkUhLS8Pu3bsxZ84c7Llmijo1
NRX79u1DdnY2PvnkEzz//PPlXmvtWhlVkvEY5c1Kt8bBk3H16gWsWiWn06nkVtLPzMxESEgIgoOD
4evri0GDBmHpNXv3U1JSMHToUABAhw4dcPLkSRSW06y9XTugdm13oiG9cHeuOZSUSHMvbm40Jj8/
IDxcBrgqudVlOz8/H0FBQZd+HxgYiO+///6Wr8nLy4O/v/9Vr6tSZSzGjpX/joqKQlRUlDuhkQeF
hEiZZ8sWLgM0sk2bgKAg+SBjKntqdnXOJT09Henp6W7F4FbSdzh5rJV2zVa08j5vypSxCA11JxrS
U9mblUnfuFjaMb4+faSD8OTJrp0KeO2AeNy4cRW+hlvlnYCAAOTm5l76fW5uLgIDA2/6mry8PAQE
BFx3LSZ8Y2Nd3/i4VNP4WrSQMumuXepicCvpR0ZGIjs7Gzk5OTh//jzmzZuHuGsa4cfFxWHmzJkA
gIyMDNSqVeu60g4ZX8eOQG6ufJDx7N8PnDgB3Huv6kjoZsp256rc8OhW0vfx8cGUKVPQo0cPRERE
YODAgQgPD8e0adMwbdo0AEBsbCwaN26MkJAQjBgxAh999JFHAifv8vEBevbk7lyjWrZMJnC5C9f4
VD81O7RrC+4qgnA4rqv7k/HMnw98/rkxNpjQ1R5+GHjlFZ44ZwbnzgH+/kB2NlCvnnvXciV3MumT
006dkpUhR45w84+RnDwJNGwIHD0q57KS8SUmyg/o/65md5kruZMPg+S0mjWB++6TDSZkHGlpwIMP
MuGbicoSD5M+VYjqeiRdj0s1zSc2Fli9Wko93sakTxXSu7ecvcrducZQUiIjfe7CNRc/PyAiQs3u
XCZ9qpAmTeTQ+h9+UB0JAcCGDUBwMFDO1hcyOFVPzUz6VGFxcSzxGAVLO+ZV9n3k7TUsTPpUYazr
GweTvnlFRMi+ip07vXtfJn2qsPvvl2Wbhw6pjsTe9u4FioqkQy2Zj8Oh5qmZSZ8qrHJlWX3A0b5a
ZbtwXWncRcag4qmZSZ9cEhcHpKSojsLeli3jDlyz69IF+Pln2VjnLUz65JLu3YGMDOD331VHYk/H
jgFZWdJ+gczrttuAHj1kGbS3MOmTS6pXBzp3ljNZyftWrJCEf8cdqiMhd3m7xMOkTy7jKh51UlJY
2rGKnj2Bb78Fzpzxzv2Y9MllffpIx82SEtWR2Mu5c8DKlXLQNplfnTpA27bAmjXeuR+TPrms7DzW
jRtVR2Iva9cCzZvLVn6yBm8ujGDSJ7dwd673sbRjPWVJ3xs9rZj0yS1xccDSpaqjsA9NY9K3opAQ
7/W0YtInt7RrBxQXAz/9pDoSe9i+HahSBQgLUx0JeVrfvt4ZQDHpk1vKtpJztO8dZaN87sK1nr59
vVPXZ9Int8XHA8nJqqOwh5QUNlizqvbtZdPd/v363odJn9wWFSXlHW9uJbej3FwgJwd44AHVkZAe
KlWSH+h6PzUz6ZPbyraScxWPvlJSZG2+j4/qSEgv3qjrM+mTR3hrEsrOkpOllEbWFR0NbNsG/Pab
fvdwaJq3z20pJwiHAwYIg9xw8iTQsCFQUCB9ecizTpwAGjWScwyqVVMdDempXz/54T5kyK1f60ru
5EifPKJWLaBDBzZg00tqKvDQQ0z4dqD3UzOTPnkMSzz6YWnHPnr3Blav1q8BG5M+eUzfvmzApoez
Z4FVqyQZkPXVrSubHlet0uf6TPrkMUFBUndev151JNayZg3QqhVQr57qSMhbEhKAJUv0uTaTPnlU
v376vVntiqUd+4mPlyXQejw1M+mTR5WNULgYyzNKS2V9ft++qiMhb2rYEAgO1uepmUmfPCo8XFaY
bN6sOhJr+P57Kes0aaI6EvI2vUo8TPrkUQ6HlHgWL1YdiTUsXixfT7KfhAQp7Xn6qZlJnzwuIUGS
FUs87tE0YNEiIDFRdSSkQni4HHy/ZYtnr8ukTx4XGSk99vfsUR2JuW3bBlSuDLRsqToSUsHh0KfE
w6RPHqfXm9Vuykb57J1vX0z6ZBqs67uP9Xxq3x44dQr4+WfPXZNJn3TxwAPA4cPS/50qbs8e4PRp
+aYn+6pUSX7wL1rkwWt67lJEl/n4yLF+LPG4ZvFiebSvxO9Q2+vfH1iwwHPX41uKdJOY6NkRip1w
1Q6VeeABaam9b59nrsekT7rp1k3KFPn5qiMxl4MH5WvGYxEJkBVcnizxMOmTbm67Tc785Gi/YhYv
lrYLlSurjoSMwpMlHiZ90tWjj3q2HmkHCxdy1Q5d7cEHZWHEwYPuX4tJn3QVEwPs2iXHKNKtHTok
tdvoaNWRkJH4+EjnTU88NTPpk65Y4qmYBQtk1Y6vr+pIyGg89dTMpE+6e/RRYP581VGYw/z5wIAB
qqMgI4qKAvbvl6dBdzDpk+5Y4nHOgQOymS0qSnUkZES+vjLB7+5TM5M+6a5KFZZ4nLFggazN9/FR
HQkZ1YAB7j81u5z0jx8/jpiYGDRt2hTdu3fHyZMny31dcHAwWrVqhbZt2+K+++5zOVAyN67iubV5
81jaoZt7+GF5IjxwwPVruJz0J0yYgJiYGOzduxfR0dGYMGFCua9zOBxIT09HVlYWMjMzXQ6UzK2s
xJOXpzoSY8rOlvLXgw+qjoSMzNdX1uzPnev6NVxO+ikpKRg6dCgAYOjQoUhOTr7hazWepmF7VarI
qpR581RHYkwLFsg3Mzdk0a0MGuRe0ne5elhYWAh/f38AgL+/PwoLC8t9ncPhQLdu3VC5cmWMGDEC
zzzzTLmvGzt27KX/joqKQhRnsywnKQkYMwYYPVp1JMYzbx7wr3+pjoKMLj09Hd9+m45Dh4AXX3Tt
GjdN+jExMTh69Oh1f/72229f9XuHwwHHDU562LBhAxo0aIBff/0VMTExCAsLQ5cuXa573ZVJn6wp
KkoaR/38M9CsmepojGP3buC334DOnVVHQkZXNiD+4w/g9tsBYFyFr3HTpL9q1aob/p2/vz+OHj2K
+vXr48iRI/Dz8yv3dQ0aNAAA1KtXDwkJCcjMzCw36ZP1Va4MDBwIzJkD8Gf8ZbNmAY89xtIOOS8p
yfVJf5dr+nFxcZgxYwYAYMaMGYiPj7/uNcXFxTh9+jQA4I8//sDKlSvRkgd+2tpjjwGzZ/PQ9DIX
L0rSHzxYdSRkJu3auX7WgstJ//XXX8eqVavQtGlTrFmzBq+//joAoKCgAL169QIAHD16FF26dEGb
Nm3QoUMH9O7dG927d3f1lmQBkZGS6LZsUR2JMWzYAFSvDrRqpToSMhOHQ0b7Ln2uZoClNQ6Hgyt8
bORvfwOKioB331UdiXrPPQcEBwP/HTMROW3PHiAiouK5k0mfvG7PHukimZtr7zr2uXNAQACwdSvQ
sKHqaMiMXMmdbMNAXhceDtSvD6Snq45ErRUrgObNmfDJu5j0SYknngBmzlQdhVqcwCUVWN4hJX75
BWjaVEo8d96pOhrvO3kSaNRIumrWrq06GjIrlnfINPz8gK5d7duEbeFCmddgwidvY9InZYYNAz7/
XHUUakyfLv9+Im9jeYeUOX8eCAwENm4EQkJUR+M9e/ZIi9zcXPbOJ/ewvEOmctttskP3vxu7bWP6
dGDoUCZc1LS0AAAJ8UlEQVR8UoMjfVJq2zYgLk4mNF3dVm4mFy4AQUHA2rVsOkfu40ifTKdNG6Bu
XeDbb1VH4h3LlwOhoUz4pA6TPin35JNS8rCD//wHGD5cdRRkZyzvkHLHjgFNmgD79gF33aU6Gv0U
FMgO3NxcabJG5C6Wd8iU6taVur7Vl2/OnAkkJjLhk1oc6ZMhbNokrRn27rXmhO7Fi7ID+YsvgI4d
VUdDVsGRPpnW/ffLCPibb1RHoo+vvwZq1JB/J5FKTPpkCA6H9JafOlV1JPr48ENg5Ej5dxKpxPIO
Gcbp09KEbOdO6TNvFfv3ywj/8GHgjjtUR0NWwvIOmdqddwKDBgGffqo6Es+aOlX67DDhkxFwpE+G
snMn8MgjskPX11d1NO4rLpZDUn74AbjnHtXRkNVwpE+m17KlNF9btEh1JJ4xZw7QqRMTPhkHkz4Z
zquvApMmAWZ/+NM0YMoUmcAlMgomfTKcXr2AP/6QpmRmtm6dlHe6dVMdCdFlTPpkOJUqAaNHA++8
ozoS90yYALz2mjU3m5F5cSKXDOnsWSA4GFizBoiIUB1NxW3bBvTuLcs1q1RRHQ1ZFSdyyTJuvx14
8UXg3XdVR+KaCROAUaOY8Ml4ONInwzp2THrP794N1K+vOhrn7dsn/XUOHJC9B0R64UifLKVuXTlO
8b33VEdSMZMmAc8/z4RPxsSRPhlaXh7QurWM9v39VUdzawUFQIsWwM8/A/XqqY6GrM6V3MmkT4b3
yivy6/vvq43DGaNHyzm4H3ygOhKyAyZ9sqSjR+XEqW3b5FBxozp8GGjbFvjxR6BBA9XRkB0w6ZNl
vf46cPIk8PHHqiO5sWHDpDvoW2+pjoTsgkmfLOvYMaBZMyAzE2jcWHU019u5U3beZmfLYSlE3sDV
O2RZdetKD5tx41RHUr433pAPJnwyOo70yTROnQLCwoCUFKB9e9XRXLZ+PTBkCPDTT9yMRd7FkT5Z
Ws2astP1hReA0lLV0YiLF4ExY6SOz4RPZsCkT6YyZIi0aDDK6Vr//rf8mpSkNg4iZ7G8Q6azY4dM
mu7apXYDVEEB0KaNNIVr0UJdHGRfXL1DtjFqlBykXjbSViExUfYP/OMf6mIge2PSJ9v4/XcgPByY
PRvo2tX791+yBPjLX2TD2O23e//+RAAncslGatSQuv4TT8gafm86dQp46SW5PxM+mQ1H+mRqr74K
7N0LLF0KOBz630/TgP79pdXzhx/qfz+im+FIn2xn/HjpzeOtBmcTJgD5+eY93IWII30yvQMHgPvv
B1asAO69V7/7rFwJPPmktIIIDNTvPkTO4kifbKlxY2DqVCA+Xs6k1cPBgzJ/MHcuEz6Zm4/qAIg8
ITER+PVXWb+/bp1nWzDn5wOxscD//i/w4IOeuy6RCkz6ZBnPPQecOQNER0vi98S5uvv3AzExcvzh
Sy+5fz0i1VjeMZj09HTVIRiGK1+LUaOkVUN0tLQ5dseuXbIHYMwY4LXX3LuWu/i+uIxfC/e4nPQX
LFiA5s2bo3Llyti6desNX5eWloawsDCEhoZi4sSJrt7ONviGvszVr8Vf/ypN2Tp1AmbMkGWWFaFp
UruPjpbVOs8951IYHsX3xWX8WrjH5aTfsmVLLFmyBA/epMhZWlqKkSNHIi0tDbt378acOXOwZ88e
V29J5BSHA3jxRemJM2mSNEP75RfnPnffPqBHD1kKumQJMHiwvrESeZvLST8sLAxNmza96WsyMzMR
EhKC4OBg+Pr6YtCgQVi6dKmrtySqkJYtgR9+kPNqmzaVTVUrVlzflvn33yXBP/OMLP3s3h3YsgXo
2FFN3ES60twUFRWlbdmypdy/W7Bggfb0009f+v0XX3yhjRw58rrXAeAHP/jBD3648FFRN129ExMT
g6NHj1735+PHj0efPn1u9qkAZOOAMzRuzCIi8oqbJv1Vq1a5dfGAgADk5uZe+n1ubi4CubOFiEgZ
jyzZvNFIPTIyEtnZ2cjJycH58+cxb948xMXFeeKWRETkApeT/pIlSxAUFISMjAz06tULPXv2BAAU
FBSgV69eAAAfHx9MmTIFPXr0QEREBAYOHIjw8HDPRE5ERBVX4VkAD1uxYoXWrFkzLSQkRJswYYLq
cJQ5fPiwFhUVpUVERGjNmzfXJk+erDokpUpKSrQ2bdpovXv3Vh2KcidOnNASExO1sLAwLTw8XNu0
aZPqkJQZP368FhERobVo0UJLSkrSzp49qzokrxk2bJjm5+entWjR4tKfHTt2TOvWrZsWGhqqxcTE
aCdOnLjldZTuyOU6/st8fX3x3nvvYdeuXcjIyMCHH35o268FAEyePBkRERFOLwawsj/96U+IjY3F
nj17sGPHDts+Lefk5ODTTz/F1q1bsXPnTpSWlmLu3Lmqw/KaYcOGIS0t7ao/mzBhAmJiYrB3715E
R0djwoQJt7yO0qTPdfyX1a9fH23atAEAVK9eHeHh4SgoKFAclRp5eXlITU3F008/bfuVXadOncL6
9esxfPhwAFIyrVmzpuKo1KhRowZ8fX1RXFyMkpISFBcXIyAgQHVYXtOlSxfUrl37qj9LSUnB0KFD
AQBDhw5FcnLyLa+jNOnn5+cj6Ip2iIGBgcjPz1cYkTHk5OQgKysLHTp0UB2KEqNGjcKkSZNQqRJb
Qx08eBD16tXDsGHD0K5dOzzzzDMoLi5WHZYSderUwejRo9GwYUPcfffdqFWrFrp166Y6LKUKCwvh
7+8PAPD390dhYeEtP0fpdxUf3a9XVFSE/v37Y/LkyahevbrqcLzuq6++gp+fH9q2bWv7UT4AlJSU
YOvWrXjhhRewdetWVKtWzalHeCvav38/3n//feTk5KCgoABFRUWYNWuW6rAMw+FwOJVTlSZ9ruO/
2oULF5CYmIjBgwcjPj5edThKbNy4ESkpKbjnnnuQlJSENWvWYMiQIarDUiYwMBCBgYFo3749AKB/
//43bXBoZZs3b0anTp1Qt25d+Pj4oF+/fti4caPqsJTy9/e/tIH2yJEj8PPzu+XnKE36XMd/maZp
eOqppxAREYFXXnlFdTjKjB8/Hrm5uTh48CDmzp2Lhx9+GDNnzlQdljL169dHUFAQ9u7dCwBYvXo1
mjdvrjgqNcLCwpCRkYEzZ85A0zSsXr0aERERqsNSKi4uDjNmzAAAzJgxw7nBol7Li5yVmpqqNW3a
VGvSpIk2fvx41eEos379es3hcGitW7fW2rRpo7Vp00ZbsWKF6rCUSk9P1/r06aM6DOW2bdumRUZG
aq1atdISEhK0kydPqg5JmYkTJ15asjlkyBDt/PnzqkPymkGDBmkNGjTQfH19tcDAQG369OnasWPH
tOjo6Aot2TTEwehEROQdXB5BRGQjTPpERDbCpE9EZCNM+kRENsKkT0RkI0z6REQ28v8ujsxbbCsI
oAAAAABJRU5ErkJggg==
"></img>
</div>
</div>
</div>
</div>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can do pretty much anything else a notebook does as well.  The IPython team did the hard part.</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<h2 class="ipynb">
  Where to go from here?
</h2>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>There&#8217;s clearly a cleaner way to do this.  If the IPython team would be open to the idea, I think their HTML stylesheets should be modified so that notebooks can be embedded within any CSS framework with as few conflicts as possible.  This means getting rid of all top-level formatting in the style-sheets, and removing potentially common class names like &#8220;highlight&#8221;.  Once this is done, <code>nbconvert.py</code> could output this directly, obviating the need for my unforgivable hack shown above.</p>
<p>Second, I&#8217;d love to build notebook support directly into octopress.  If <code>nbconvert.py</code> is available on the user&#8217;s system, it could be called directly from the Ruby script that generates Octopress HTML.  I have about as much experience with Ruby as I do with Swahili (read: None) so this would take some work for me.  I&#8217;d be happy to pass the baton to any Octopress gurus out there&#8230;</p>
<p>Either of those options will smooth out the notebook/blogging combo considerably, and give me the potential to prognosticate Python in perpetuum.
By the way, the notebook used to generate this page can be downloaded <a href="http://jakevdp.github.com/downloads/notebooks/nb_in_octopress.ipynb">here</a>.  Happy coding!</p>
</div>

</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Optical Illusions in Matplotlib]]></title>
    <link href="http://jakevdp.github.com/blog/2012/09/26/optical-illusions-in-matplotlib/"/>
    <updated>2012-09-26T07:27:00-07:00</updated>
    <id>http://jakevdp.github.com/blog/2012/09/26/optical-illusions-in-matplotlib</id>
    <content type="html"><![CDATA[<p>A while ago I posted some information on the new matplotlib animation
package (see my tutorial
<a href="http://jakevdp.github.com/blog/2012/08/18/matplotlib-animation-tutorial">here</a> and
a followup post <a href="http://jakevdp.github.com/blog/2012/09/05/quantum-python">here</a>).  In them, I show
how easy it is to  use matplotlib to create simple animations.</p>

<p>This morning I came across this cool optical illusion on
<a href="http://gizmodo.com/5945194/this-optical-trick-is-annoying-the-hell-out-of-me">gizmodo</a></p>

<!-- more -->


<p><a href="http://gizmodo.com/5945194/this-optical-trick-is-annoying-the-hell-out-of-me"><img src="http://jakevdp.github.com/images/original_illusion.gif"></a></p>

<p>It intrigued me, so I decided to see if I could create it using matplotlib.
Using my previous template and a bit of geometry, I was able to finish it
before breakfast!  Here&#8217;s the code:</p>

<figure class='code'><figcaption><span>Optical Illusion (animate_square.py)</span> <a href='http://jakevdp.github.com/downloads/code/animate_square.py'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">Optical Illusion in Matplotlib</span>
</span><span class='line'>
</span><span class='line'><span class="sd">author: Jake Vanderplas</span>
</span><span class='line'><span class="sd">email: vanderplas@astro.washington.edu</span>
</span><span class='line'><span class="sd">website: http://jakevdp.github.com</span>
</span><span class='line'><span class="sd">license: BSD</span>
</span><span class='line'><span class="sd">Please feel free to use and modify this, but keep the above information.</span>
</span><span class='line'><span class="sd">Thanks!</span>
</span><span class='line'><span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">animation</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">RegularPolygon</span>
</span><span class='line'>
</span><span class='line'><span class="c"># First set up the figure, the axis, and the plot element we want to animate</span>
</span><span class='line'><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
</span><span class='line'><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="n">aspect</span><span class="o">=</span><span class="s">&#39;equal&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Add lines and patches</span>
</span><span class='line'><span class="n">lines</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">squares</span> <span class="o">=</span> <span class="p">[</span><span class="n">RegularPolygon</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span><span class="p">),</span>
</span><span class='line'>                          <span class="mi">4</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">)</span>
</span><span class='line'>           <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]]</span>
</span><span class='line'><span class="k">for</span> <span class="n">sq</span> <span class="ow">in</span> <span class="n">squares</span><span class="p">:</span>
</span><span class='line'>    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">sq</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># initialization function: plot the background of each frame</span>
</span><span class='line'><span class="k">def</span> <span class="nf">init</span><span class="p">():</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span><span class='line'>        <span class="n">line</span><span class="o">.</span><span class="n">set_data</span><span class="p">([],</span> <span class="p">[])</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">sq</span> <span class="ow">in</span> <span class="n">squares</span><span class="p">:</span>
</span><span class='line'>        <span class="n">sq</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">lines</span> <span class="o">+</span> <span class="n">squares</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># animation function.  This is called sequentially</span>
</span><span class='line'><span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span class='line'>    <span class="c"># Set transparency level for squares</span>
</span><span class='line'>    <span class="n">level</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">0.005</span> <span class="o">*</span> <span class="n">i</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
</span><span class='line'>    <span class="n">level</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="n">level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="n">sq</span> <span class="ow">in</span> <span class="n">squares</span><span class="p">:</span>
</span><span class='line'>        <span class="n">sq</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># Set location for lines</span>
</span><span class='line'>    <span class="n">s</span> <span class="o">=</span> <span class="mf">0.6</span>
</span><span class='line'>    <span class="n">d1</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">0.05</span> <span class="o">*</span> <span class="n">i</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
</span><span class='line'>    <span class="n">d2</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">0.05</span> <span class="o">*</span> <span class="n">i</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_data</span><span class="p">([(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">d1</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
</span><span class='line'>                      <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">d1</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)],</span>
</span><span class='line'>                     <span class="p">[(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">d1</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
</span><span class='line'>                      <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">d1</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_data</span><span class="p">([(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">d1</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
</span><span class='line'>                      <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">d1</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)],</span>
</span><span class='line'>                     <span class="p">[(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">d1</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
</span><span class='line'>                      <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">d1</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">lines</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_data</span><span class="p">([(</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">d2</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
</span><span class='line'>                      <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">d2</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)],</span>
</span><span class='line'>                     <span class="p">[(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">d2</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
</span><span class='line'>                      <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">d2</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">lines</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_data</span><span class="p">([(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">d2</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
</span><span class='line'>                      <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">d2</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)],</span>
</span><span class='line'>                     <span class="p">[(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">d2</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
</span><span class='line'>                      <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">d2</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">lines</span> <span class="o">+</span> <span class="n">squares</span>
</span><span class='line'>
</span><span class='line'><span class="c"># call the animator.  blit=True means only re-draw parts that have changed.</span>
</span><span class='line'><span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">init_func</span><span class="o">=</span><span class="n">init</span><span class="p">,</span>
</span><span class='line'>                               <span class="n">frames</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">28</span><span class="p">,</span> <span class="n">blit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># save the animation as an mp4.  This requires ffmpeg or mencoder to be</span>
</span><span class='line'><span class="c"># installed.  The extra_args ensure that the x264 codec is used, so that</span>
</span><span class='line'><span class="c"># the video can be embedded in html5.  You may need to adjust this for</span>
</span><span class='line'><span class="c"># your system: for more information, see</span>
</span><span class='line'><span class="c"># http://matplotlib.sourceforge.net/api/animation_api.html</span>
</span><span class='line'><span class="c">#anim.save(&#39;basic_animation.mp4&#39;, fps=30, extra_args=[&#39;-vcodec&#39;, &#39;libx264&#39;])</span>
</span><span class='line'>
</span><span class='line'><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>And here&#8217;s the result:</p>

<p><video width='360' height='270' preload='none' controls poster=' /downloads/videos/animate_square.png'><source src='http://jakevdp.github.com/downloads/videos/animate_square.mp4' type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"'/></video></p>

<p>This just confirms my suspicion that a few lines of python really can do
anything.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Why Python is the Last Language You'll Have To Learn]]></title>
    <link href="http://jakevdp.github.com/blog/2012/09/20/why-python-is-the-last/"/>
    <updated>2012-09-20T20:50:00-07:00</updated>
    <id>http://jakevdp.github.com/blog/2012/09/20/why-python-is-the-last</id>
    <content type="html"><![CDATA[<p>This week, for part of a textbook I&#8217;m helping to write,
I spent some time reading and researching the history of Python as
a scientific computing tool.  I had heard bits and pieces of this in the past,
but it was fascinating to put it all together and learn about how all the
individual contributions that have made Python what it is today.
All of this got me thinking: for most of us, Python was a replacement for
something: IDL, MatLab, Java, Mathematica, Perl&#8230; you name it.
But what will replace Python?
Ten years down the road, what language will people be espousing in
blogs with awkwardly-alliterated titles?  As I thought it through, I
became more and more convinced that, at least in the scientific computing
world, Python is here to stay.</p>

<!-- more -->


<p>Now I’m not simply talking about inertia.  Javascript has inertia, and that&#8217;s
a main reason that web admins still begrudgingly use it.  But Python is
different.  Yes, it&#8217;s everywhere, and yes, something so ubiquitous is
hard to shake.  But look at the 1970s: punch card programming was
everywhere, and now it&#8217;s nothing but a footnote. Inertia can be overcome
with time.  But I think Python’s hold is much deeper than that: I think it
will remain relevant long into the future.  Here’s why:</p>

<h2>GitHub</h2>

<p>The first reason Python will be around for a while is
<a href="http://github.com">GitHub</a>.  GitHub has done wonders both for Python
and for the broader open source community.
It has replaced the clunky Trac system of
submitting static patches to projects, and removed the contribution barrier
for the core scientific python projects.  Numpy, Scipy, and Matplotlib were
all moved to GitHub in late 2010, and the results have been impressive.
I did some quick data mining of the commit logs on GitHub to learn
about the rate of new author contributions to core python projects with
time, and this is what I found:</p>

<p><img src="http://jakevdp.github.com/figures/author_count.png" width="600" title="[Cumulative number of contributors for python packages]" ></p>

<p>See it? The late 2010 transition to GitHub is extremely apparent,
and this reflects the first reason that NumPy, SciPy, Matplotlib,
and Python will remain relevant far into the future.
Python not only has an astoundingly large user-base; thanks to GitHub,
it has an astoundingly large and ever-increasing <em>developer</em> base.
And that means Python is well-poised to evolve as the needs of users change.</p>

<h2>Julia</h2>

<p>The second reason Python will be around for a while is
<a href="http://julialang.org/">Julia</a>.  This statement may strike some as strange:
Julia is a
language which aims to improve on many of Python’s weaknesses.
It uses JIT compilation and efficient built-in array
support to beat Python on nearly every benchmark.  It seems a likely
candidate to <em>replace</em> Python, not a support for my assertion that Python will
remain relevant. But this is the thing: Python’s strength lies in community,
and that community is incredibly difficult to replicate.</p>

<p>A recent
<a href="https://groups.google.com/forum/?fromgroups=#!topic/julia-dev/YftOOEfcwrk">thread</a>
on the julia-dev list highlights what I’m talking about:
in it, Dag Seljebotn, a core developer of Cython, contrasts the
strengths of Python (large user- and developer-base, large collection of
libraries) with the strengths of Julia (state-of-the-art performance,
JIT compilation).  He
proposes that the two languages should work together, each drawing from the
strengths of the other.  The response from the Julia community was incredibly
positive.</p>

<p>The Julia developers know that Julia can’t succeed as a scientific
computing platform without building an active community, and currently the
best way to do that is to work hand-in-hand with Python.  After this thread
on julia-dev, the Julia  developers were invited to give
<a href="http://pyvideo.org/video/1204/julia-a-fast-dynamic-language-for-technical-comp">a talk</a>
at the Scipy2012 conference,
and I think many would say that some good bridges were built.
I&#8217;m extremely excited about the prospects of Julia as a scientific computing
platform, but it will only succeed if it can embrace Python, and if Python
can embrace it.</p>

<h2>The next Travis Oliphant</h2>

<p>The third reason Python will be around for a while is this: <em>there will be
another Travis Oliphant</em>.  What do I mean by this?  Well, if you go back
ten years or so, the Python scientific community was looking a bit weak.
Numeric was a
well-established array interface, and the beginnings of SciPy were built
upon it.  But Numeric was clunky, so some folks got together and built
Numarray.  Numarray fixed some of the problems, but had its own weaknesses.
The biggest problem, though, was that it split the community:
when the core of your platform has divided allegiances, neither side wins.
Travis realized this, and against the advice of many, audaciously set out
on a quest to unify the two.  The result was NumPy, which is now the
unrivaled basis for nearly all scientific tools in Python.</p>

<p>Python faces a similar crisis today: it is split in the area of
High-performance and parallel computing.  There is an alphabet soup of
packages which aim to address this:
Cython, PyPy, Theano, Numba, Numexpr, and more.  But
here’s the thing: someone <em>will</em> come along who has the audacity to strike
out and unify them.  I love this recent tweet by Dave Warde-Farley:</p>

<p><a href="http://twitter.com/dwf/status/246756226367643650"><img src="http://jakevdp.github.com/images/dwf_tweet.png" width="400" title="[Cumulative number of contributors for python packages]" ></a></p>

<p>Somebody is going to do this: somebody will be the next Travis Oliphant
and create NumTron to re-unite the community.
Maybe Dave will be the next Travis Oliphant: he&#8217;s done some great work on
<a href="http://deeplearning.net/software/theano/">Theano</a>.
But then again, the merging of Python and LLVM in Travis&#8217;
<a href="http://numba.pydata.org/">Numba</a> project is
<a href="http://jakevdp.github.com/blog/2012/08/24/numba-vs-cython/">pretty exciting</a>:
maybe Travis Oliphant will be the next Travis Oliphant &#8211;
he’s done it before, after all.  Or perhaps it will be someone
we’ve never heard of, who as we speak is brewing a new idea in
an unwatched GitHub repository. Time will tell,
but I’m confident that it will happen.</p>

<h2>Conclusion</h2>

<p>Maybe I’ve convinced you, maybe I haven’t.  But I’m going to continue using
Python, and I predict you will too.  We&#8217;ll see what the future holds for
scientific computing, but in my mind, Python remains a pretty solid bet.</p>

<p><em>Finally, a brief post-script on the history of Python:
some of the most interesting sources I found were
<a href="http://www.artima.com/intv/pythonP.html">this interview</a> with Guido Van Rossum,
the official <a href="http://www.scipy.org/History_of_SciPy">Scipy history page</a>, the
<a href="http://pyvideo.org/video/1192/matplotlib-lessons-from-middle-age-or-how-you">Scipy2012 talk</a>
John Hunter gave this summer shortly before his sudden passing,
and the <a href="http://mail.scipy.org/pipermail/numpy-discussion/2012-February/060640.html">numpy-discussion post</a>
John referenced in his talk.  If you use Python regularly and have some
time, I’d highly recommend browsing these: it’s incredible to see
how the unwavering vision of folks throughout the years has led to what we
have today: an unmatched open-source environment for scientific computing.</em></p>

<p><em>Edit: also check out the
<a href="http://python-history.blogspot.com/">History of Python</a> blog.  Thanks to
Fernando for the tip</em></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Dynamic Programming in Python: Bayesian Blocks]]></title>
    <link href="http://jakevdp.github.com/blog/2012/09/12/dynamic-programming-in-python/"/>
    <updated>2012-09-12T19:02:00-07:00</updated>
    <id>http://jakevdp.github.com/blog/2012/09/12/dynamic-programming-in-python</id>
    <content type="html"><![CDATA[<p>Of all the programming styles I have learned,
<a href="http://en.wikipedia.org/wiki/Dynamic_programming">dynamic programming</a>
is perhaps the most beautiful.  It can take problems that, at first glance,
look ugly and intractable, and solve the problem with clean, concise code.
Where a simplistic algorithm might accomplish something by brute force,
dynamic programming steps back, breaks the task into a smaller set of
sequential parts, and then proceeds in the most efficient way possible.</p>

<h3>Bayesian Blocks</h3>

<p>I&#8217;ll go through an example here where the ideas of dynamic programming
are vital to some very cool data analysis resuts.
This post draws heavily from a recent
<a href="http://adsabs.harvard.edu/abs/2012arXiv1207.5578S">paper</a> by Jeff Scargle
and collaborators (this is the Scargle of <em>Lomb-Scargle Periodogram</em>
fame), as well as some conversations I had with Jeff at
<a href="http://www.astro.caltech.edu/ai12/">Astroinformatics 2012</a>.
The paper discusses
a framework called <em>Bayesian Blocks</em>, which is essentially a method of
creating histograms with bin sizes that adapt to the data (there&#8217;s a bit
more to it than that: here we&#8217;ll focus on histograms for simplicity).</p>

<!-- more -->


<p>To motivate this, let&#8217;s take a look at the histogram of some sampled data.
We&#8217;ll create a complicated set of random data in the following way:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># Define our test distribution: a mix of Cauchy-distributed variables</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
</span><span class='line'>
</span><span class='line'><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">stats</span><span class="o">.</span><span class="n">cauchy</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span>
</span><span class='line'>                    <span class="n">stats</span><span class="o">.</span><span class="n">cauchy</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">2000</span><span class="p">),</span>
</span><span class='line'>                    <span class="n">stats</span><span class="o">.</span><span class="n">cauchy</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span>
</span><span class='line'>                    <span class="n">stats</span><span class="o">.</span><span class="n">cauchy</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span>
</span><span class='line'>                    <span class="n">stats</span><span class="o">.</span><span class="n">cauchy</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">500</span><span class="p">)])</span>
</span><span class='line'>
</span><span class='line'><span class="c"># truncate values to a reasonable range</span>
</span><span class='line'><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now what does this distribution look like?  We can plot a histogram to find
out:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">pylab</span> <span class="kn">as</span> <span class="nn">pl</span>
</span><span class='line'><span class="n">pl</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://jakevdp.github.com/figures/bayesblocks1.png" title="[Simple Histogram of our Distribution]" ></p>

<p>Not too informative.  The default bins in <code>matplotlib</code> are too wide for this
dataset.  We might be able to do better by increasing the number of bins:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">pl</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://jakevdp.github.com/figures/bayesblocks2.png" title="[More Detailed Histogram of our Distribution]" ></p>

<p>This is better.  But having to choose the bin width each time we plot a
distribution is not only tiresome, it may lead to missing some important
information in our data.  In a perfect world, we&#8217;d like for
the bin width to be learned in an automated fashion, based on the
properties of the data itself.
There have been many rules-of-thumb proposed for this task
(look up <em>Scott&#8217;s Rule</em>, <em>Knuth&#8217;s Rule</em>, the <em>Freedman-Diaconis Rule</em>,
and others in your favorite statistics text).
But all these rules of thumb share a disadvantage: they make the assumption
that all the bins are the same size.  This is not necessarily optimal.  But
can we do better?</p>

<p>Scargle and collaborators showed that the answer is yes.  This is their insight:
For a set of histogram bins or <em>blocks</em>, each of an arbitrary size,
one can use a Bayesian
likelihood framework to compute a <em>fitness function</em> which only depends on
two numbers: the width of each block, and the number of points in each block.
The edges between these blocks (the <em>change-points</em>) can be varied, and
the overall block configuration with the maximum fitness is quantitatively
the best binning.</p>

<p>Simple, right?</p>

<p>Well, no.  The problem is, as the number of points N grows large, the number
of possible configurations grows as 2<sup>N</sup> .  For N=300 points, there are already
more possible configurations than the number of subatomic particles in the
observable universe!  Clearly an exhaustive search will fail in cases of
interest.  This is where <em>dynamic programming</em> comes to the rescue.</p>

<h3>Dynamic Programming</h3>

<p>Dynamic programming is very similar to mathematical proof by induction. By
way of example, consider the formula</p>

<p>$1 + 2 + \cdots + n = \frac{n(n+1)}{2}$.</p>

<p>How could you prove that this is true for all positive integers $n$?
An inductive proof of this formula proceeds in the following fashion:</p>

<ol>
<li><p><strong>Base Case</strong>: We can easily show that the formula holds for $n = 1$.</p></li>
<li><p><strong>Inductive Step</strong>: For some value $k$, assume that
$1 + 2 + \cdots + k = \frac{k(k+1)}{2}$ holds.
Adding $(k + 1)$ to each side and rearranging the result yields
$1 + 2 + \cdots + k + (k + 1) = \frac{(k + 1)(k + 2)}{2}$.  Looking
closely at this, we see that we have shown the following:
if our formula is true for $k$, then it must be true for $k + 1$.</p></li>
<li>By 1 and 2, we can show that the formula is true for any positive integer
$n$, simply by starting at $n=1$ and repeating the inductive step
$n - 1$ times.</li>
</ol>


<p>Dynamic programming proceeds in much the same vein.  In our Bayesian Blocks
example, we can easily find the optimal binning for a single point.  By
making use of some mathematical proofs concerning the fitness functions,
we can devise a simple step from the optimal binning for $k$ points to the
optimal binning for $k + 1$ points (the details can be found in the
appendices of the
<a href="http://adsabs.harvard.edu/abs/2012arXiv1207.5578S">Scargle paper</a>).
In this way, Scargle and collaborators showed that the 2<sup>N</sup> possible states
can be explored in N<sup>2</sup> time.</p>

<h3>The Algorithm</h3>

<p>The resulting algorithm is deceptively simple, but it can be proven to converge
to the single best configuration among the 2<sup>N</sup> possibilities.  Below is the
basic code written in python.  Note that there are a few details that are
missing from this version (e.g. priors on the number of bins, other forms
of fitness functions, etc.) but this gets the basic job done:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">bayesian_blocks</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;Bayesian Blocks Implementation</span>
</span><span class='line'>
</span><span class='line'><span class="sd">    By Jake Vanderplas.  License: BSD</span>
</span><span class='line'><span class="sd">    Based on algorithm outlined in http://adsabs.harvard.edu/abs/2012arXiv1207.5578S</span>
</span><span class='line'>
</span><span class='line'><span class="sd">    Parameters</span>
</span><span class='line'><span class="sd">    ----------</span>
</span><span class='line'><span class="sd">    t : ndarray, length N</span>
</span><span class='line'><span class="sd">        data to be histogrammed</span>
</span><span class='line'>
</span><span class='line'><span class="sd">    Returns</span>
</span><span class='line'><span class="sd">    -------</span>
</span><span class='line'><span class="sd">    bins : ndarray</span>
</span><span class='line'><span class="sd">        array containing the (N+1) bin edges</span>
</span><span class='line'>
</span><span class='line'><span class="sd">    Notes</span>
</span><span class='line'><span class="sd">    -----</span>
</span><span class='line'><span class="sd">    This is an incomplete implementation: it may fail for some</span>
</span><span class='line'><span class="sd">    datasets.  Alternate fitness functions and prior forms can</span>
</span><span class='line'><span class="sd">    be found in the paper listed above.</span>
</span><span class='line'><span class="sd">    &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="c"># copy and sort the array</span>
</span><span class='line'>    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span><span class='line'>    <span class="n">N</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># create length-(N + 1) array of cell edges</span>
</span><span class='line'>    <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">t</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span>
</span><span class='line'>                            <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
</span><span class='line'>                            <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]])</span>
</span><span class='line'>    <span class="n">block_length</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">edges</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># arrays needed for the iteration</span>
</span><span class='line'>    <span class="n">nn_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
</span><span class='line'>    <span class="n">best</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span class='line'>    <span class="n">last</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">#-----------------------------------------------------------------</span>
</span><span class='line'>    <span class="c"># Start with first data cell; add one cell at each iteration</span>
</span><span class='line'>    <span class="c">#-----------------------------------------------------------------</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">K</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
</span><span class='line'>        <span class="c"># Compute the width and count of the final bin for all possible</span>
</span><span class='line'>        <span class="c"># locations of the K^th changepoint</span>
</span><span class='line'>        <span class="n">width</span> <span class="o">=</span> <span class="n">block_length</span><span class="p">[:</span><span class="n">K</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">block_length</span><span class="p">[</span><span class="n">K</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span class='line'>        <span class="n">count_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">nn_vec</span><span class="p">[:</span><span class="n">K</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># evaluate fitness function for these possibilities</span>
</span><span class='line'>        <span class="n">fit_vec</span> <span class="o">=</span> <span class="n">count_vec</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">count_vec</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">width</span><span class="p">))</span>
</span><span class='line'>        <span class="n">fit_vec</span> <span class="o">-=</span> <span class="mi">4</span>  <span class="c"># 4 comes from the prior on the number of changepoints</span>
</span><span class='line'>        <span class="n">fit_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">best</span><span class="p">[:</span><span class="n">K</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># find the max of the fitness: this is the K^th changepoint</span>
</span><span class='line'>        <span class="n">i_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">fit_vec</span><span class="p">)</span>
</span><span class='line'>        <span class="n">last</span><span class="p">[</span><span class="n">K</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_max</span>
</span><span class='line'>        <span class="n">best</span><span class="p">[</span><span class="n">K</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_vec</span><span class="p">[</span><span class="n">i_max</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">#-----------------------------------------------------------------</span>
</span><span class='line'>    <span class="c"># Recover changepoints by iteratively peeling off the last block</span>
</span><span class='line'>    <span class="c">#-----------------------------------------------------------------</span>
</span><span class='line'>    <span class="n">change_points</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span class='line'>    <span class="n">i_cp</span> <span class="o">=</span> <span class="n">N</span>
</span><span class='line'>    <span class="n">ind</span> <span class="o">=</span> <span class="n">N</span>
</span><span class='line'>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>        <span class="n">i_cp</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">change_points</span><span class="p">[</span><span class="n">i_cp</span><span class="p">]</span> <span class="o">=</span> <span class="n">ind</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">ind</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>            <span class="k">break</span>
</span><span class='line'>        <span class="n">ind</span> <span class="o">=</span> <span class="n">last</span><span class="p">[</span><span class="n">ind</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</span><span class='line'>    <span class="n">change_points</span> <span class="o">=</span> <span class="n">change_points</span><span class="p">[</span><span class="n">i_cp</span><span class="p">:]</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">edges</span><span class="p">[</span><span class="n">change_points</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>The details of the step from $K$ to $K + 1$ may be a bit confusing from this
implementation: it boils down to the fact that Scargle <em>et al.</em> were able to
show that given an optimal configuration of $K$ points, the $(K + 1)$<sup>th</sup>
configuration is limited to one of $K$ possibilities.</p>

<p>The function as written above takes a sequence of points, and returns the
edges of the optimal bins.  We&#8217;ll visualize the result on top of the histogram
we saw earlier:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># plot a standard histogram in the background, with alpha transparency</span>
</span><span class='line'><span class="n">H1</span> <span class="o">=</span> <span class="n">hist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s">&#39;stepfilled&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'><span class="c"># plot an adaptive-width histogram on top</span>
</span><span class='line'><span class="n">H2</span> <span class="o">=</span> <span class="n">hist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bayesian_blocks</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="n">histtype</span><span class="o">=</span><span class="s">&#39;step&#39;</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://jakevdp.github.com/figures/bayesblocks3.png" title="[Adaptive Histogram of our Distribution]" ></p>

<p>The adaptive-width bins lead to a very clean representation of the important
features in the data.  More importantly, these bins are quantifiably optimal,
and their properties can be used to make quantitative statistical
statements about the nature of the data.  This type of procedure has proven
very useful in analysis of time-series data in Astronomy.</p>

<h3>Conclusion</h3>

<p>We&#8217;ve just scratched the surface of Bayesian Blocks and Dynamic Programming.
Some of the more interesting details of this algorithm require much more
depth: the appendicies of the
<a href="http://adsabs.harvard.edu/abs/2012arXiv1207.5578S">Scargle paper</a>
provide these details.  Dynamic Programming ideas have been shown to be
useful in many optimization problems.  One other example I&#8217;ve worked with
extensively is
<a href="http://en.wikipedia.org/wiki/Dijkstra%27s_algorithm">Dijkstra&#8217;s Algorithm</a>
for computing the shortest paths on a connected graph.  This is available in
the <a href="http://docs.scipy.org/doc/scipy/reference/tutorial/csgraph.html">scipy.sparse.csgraph</a>
submodule, which is included in the most recent release of scipy.</p>

<p>The above python implementation of Bayesian Blocks
is an extremely basic form of the algorithm: I plan to include some
more sophisticated options in the python package I&#8217;m currently
working on, called <em>astroML: Machine Learning for Astrophysics</em>.
I&#8217;ll release version 0.1 of astroML at the end of October 2012,
in time to present it at <a href="http://c3.nasa.gov/dashlink/events/1/">CIDU 2012</a>.
If you&#8217;re interested, I&#8217;ll have updates here on the blog, as well as on
my <a href="http://twitter.com/jakevdp">twitter feed</a>.</p>

<p>Finally, all of the above code snippets are available as an ipython
notebook: <a href="http://jakevdp.github.com/downloads/notebooks/bayesian_blocks.ipynb">bayesian_blocks.ipynb</a>.
For information on how to view this file, see the
<a href="http://ipython.org/ipython-doc/dev/interactive/htmlnotebook.html">IPython page</a>.
Alternatively, you can view this notebook (but not modify it) using the
nbviewer utility <a href="http://nbviewer.ipython.org/url/jakevdp.github.com/downloads/notebooks/bayesian_blocks.ipynb">here</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Quantum Python: Animating the Schrodinger Equation]]></title>
    <link href="http://jakevdp.github.com/blog/2012/09/05/quantum-python/"/>
    <updated>2012-09-05T20:12:00-07:00</updated>
    <id>http://jakevdp.github.com/blog/2012/09/05/quantum-python</id>
    <content type="html"><![CDATA[<p>In a <a href="http://jakevdp.github.com/blog/2012/08/18/matplotlib-animation-tutorial/">previous post</a>
I explored the new animation capabilities of the latest
<a href="http://matplotlib.sourceforge.net">matplotlib</a> release.
It got me wondering whether it would be possible to simulate more complicated
physical systems in real time in python.  Quantum Mechanics was the first
thing that came to mind.  It turns out that by mixing a bit of Physics
knowledge with a bit of computing knowledge, it&#8217;s quite straightforward
to simulate and animate a simple quantum mechanical system with python.</p>

<h2>The Schrodinger Equation</h2>

<p>The dynamics of a one-dimensional quantum system are governed by the
time-dependent Schrodinger equation:</p>

<div markdown="0">\[
i\hbar\frac{\partial \psi}{\partial t}
  = \frac{-\hbar^2}{2m} \frac{\partial^2 \psi}{\partial x^2} + V \psi
\]</div>




<!-- more -->


<p>The <em>wave function</em> $\psi$ is a function of both position $x$ and time $t$,
and is the fundamental description of the realm of the very small.
Imagine we are following the motion of a single particle in one
dimension.  This wave function represents a probability of measuring
the particle at a position $x$ at a time $t$. Quantum mechanics tells us that
(contrary to our familiar classical reasoning) this probability is not
a limitation of our knowledge of the system, but a reflection of an
unavoidable uncertainty about the position and time of events in the realm
of the very small.</p>

<p>Still, this equation is a bit opaque, but to visualize the results we&#8217;ll need
to solve this numerically.  We&#8217;ll approach this using the split-step Fourier
method.</p>

<h2>The Split-step Fourier Method</h2>

<p>A standard way to numerically solve certain differential equations is
through the use of the Fourier transform.  We&#8217;ll use a Fourier convention
of the following form:</p>

<div markdown="0">\[
\widetilde{\psi}(k, t) = \frac{1}{\sqrt{2\pi}}
  \int_{-\infty}^{\infty} \psi(x, t) e^{-ikx} dx
\]</div>


<p>Under this convention, the associated inverse Fourier Transform is given by:</p>

<div markdown="0">\[
\psi(x, t) = \frac{1}{\sqrt{2\pi}}
  \int_{-\infty}^{\infty} \widetilde{\psi}(k, t) e^{ikx} dk
\]</div>


<p>Substituting this into the Schrodinger equation and simplifying gives the
Fourier-space form of the Schrodinger equation:</p>

<div markdown="0">\[
i\hbar\frac{\partial \widetilde{\psi}}{\partial t}
  = \frac{\hbar^2 k^2}{2m} \widetilde{\psi}
  + V(i\frac{\partial}{\partial k})\widetilde{\psi}
\]</div>


<p>The two versions of the Schrodinger equation contain an interesting symmetry:
the time step in each case depends on a straightforward multiplication of
the wave function $\psi$, as well as a more complicated term involving
derivatives with respect to $x$ or $k$.  The key observation is that while
the equation is difficult to evaluate fully within one of the forms, each
basis offers a straightforward calculation of one of the two contributions.
This suggests an efficient strategy to numerically solve the Schrodinger
Equation.</p>

<p>First we solve the straightforward part of the $x$-space Schrodinger
equation:</p>

<div markdown="0">\[
i\hbar\frac{\partial \psi}{\partial t}
  = V(x) \psi
\]</div>


<p>For a small time step $\Delta t$, this has a solution of the form</p>

<div markdown="0">\[
\psi(x, t + \Delta t) = \psi(x, t) e^{-i V(x) \Delta t / \hbar}
\]</div>


<p>Second, we solve the straightforward part of the $k$-space Schrodinger
equation:</p>

<div markdown="0">\[
i\hbar\frac{\partial \widetilde{\psi}}{\partial t}
  = \frac{\hbar^2 k^2}{2 m} \widetilde{\psi}
\]</div>


<p>For a small time step $\Delta t$, this has a solution of the form</p>

<div markdown="0">\[
\widetilde{\psi}(k, t + \Delta t)
    = \widetilde{\psi}(k, t) e^{-i \hbar k^2 \Delta t / 2m}
\]</div>


<h2>Numerical Considerations</h2>

<p>Solving this system numerically will require repeated computations of the
Fourier transform of $\psi(x, t)$ and the inverse Fourier transform of
$\widetilde{\psi}(k, t)$.  The best-known algorithm for computation of
numerical Fourier transforms is the Fast Fourier Transform (FFT), which
is <a href="http://docs.scipy.org/doc/scipy/reference/fftpack.html">available in scipy</a>
and efficiently computes the following form of the
discrete Fourier transform:</p>

<div markdown="0">\[
  \widetilde{F}_m = \sum_{n=0}^{N-1} F_n e^{-2\pi i n m / N}
\]</div>


<p>and its inverse</p>

<div markdown="0">\[
  F_n = \frac{1}{N} \sum_{m=0}^{N-1} \widetilde{F}_m e^{2\pi i n m / N}
\]</div>


<p>We need to know how these relate to the continuous Fourier transforms defined
and used above.  Let&#8217;s take the example of the forward transform.  Assume that
the infinite integral is well-approximated by the finite integral from
$a$ to $b$, so that we can write</p>

<div markdown="0">\[
\widetilde{\psi}(k, t) = \frac{1}{\sqrt{2\pi}}
   \int_a^b \psi(x, t) e^{-ikx} dx
\]</div>


<p>This approximation ends up being equivalent to assuming that the potential
$V(x) \to \infty$ at $x \le a$ and $x \ge b$.  We&#8217;ll now approximate this
integral as a Riemann sum of $N$ terms, and define $\Delta x = (b - a) / N$,
and $x_n = a + n\Delta x$:</p>

<div markdown="0">\[
\widetilde{\psi}(k, t) \simeq \frac{1}{\sqrt{2\pi}}
   \sum_{n=0}^{N-1} \psi(x_n, t) e^{-ikx_n} \Delta x
\]</div>


<p>This is starting to look like the discrete Fourier transform!  To bring it
even closer, let&#8217;s define $k_m = k_0 + m\Delta k$, with
$\Delta k = 2\pi / (N\Delta x)$.  Then our approximation becomes</p>

<div markdown="0">\[
\widetilde{\psi}(k_m, t) \simeq \frac{1}{\sqrt{2\pi}}
   \sum_{n=0}^{N-1} \psi(x_n, t) e^{-ik_m x_n} \Delta x
\]</div>


<p>(Note that just as we have limited the range of $x$ above, we have here limited
the range of $k$ as well.  This means that high-frequency components of the
signal will be lost in our approximation.  The Nyquist sampling theorem tells
us that this is an unavoidable consequence of choosing discrete steps in
space, and it can be shown that the spacing we chose above exactly satisfies
the Nyquist limit if we choose $k_0 = - \pi / \Delta x$).</p>

<p>Plugging our expressions for $x_n$ and $k_m$ into the Fourier
approximation and rearranging, we find the following:</p>

<div markdown="0">\[
\left[\widetilde{\psi}(k_m, t) e^{i m x_0 \Delta k}\right]
   \simeq \sum_{n=0}^{N-1} 
   \left[ \frac{\Delta x}{\sqrt{2\pi}}
   \psi(x_n, t) e^{-ik_0 x_n} \right]
   e^{-2\pi i m n / N}
\]</div>


<p>Similar arguments from the inverse Fourier transform yield:</p>

<div markdown="0">\[
\left[\frac{\Delta x}{\sqrt{2 \pi}} \psi(x_n, t) e^{-i k_0 x_n}\right]
   \simeq \frac{1}{N} \sum_{m=0}^{N-1} 
   \left[\widetilde{\psi}(k_m, t) e^{-i m x_0 \Delta k} \right]
   e^{2\pi i m n / N}
\]</div>


<p>Comparing these to the discrete Fourier transforms above, we find that the
<em>continuous</em> Fourier pair</p>

<div markdown="0">\[
   \psi(x, t) \Longleftrightarrow \widetilde{\psi}(k, t)
\]</div>


<p>corresponds to the <em>discrete</em> Fourier pair</p>

<div markdown="0">\[
   \frac{\Delta x}{\sqrt{2 \pi}} \psi(x_n, t) e^{-i k_0 x_n}
   \Longleftrightarrow
   \widetilde{\psi}(k_m, t) e^{-i m x_0 \Delta k}
\]</div>


<p>subject to the approximations mentioned above.  This allows a fast numerical
evaluation of the Schrodinger equation.</p>

<h2>Putting It All Together: the Algorithm</h2>

<p>We now put this all together using the following algorithm</p>

<ol>
<li><p>Choose $a$, $b$, $N$, and $k_0$ as above, sufficient to represent the
initial state of your wave function $\psi(x)$. (<strong>Warning:</strong> this is perhaps
the hardest part of the entire solution. If limits in $x$ or $k$ are chosen
which do not suit your problem, then the approximations used above can
destroy the accuracy of the calculation!)  Once these are chosen, then
$\Delta x = (b - a) / N$ and $\Delta k = 2\pi / (b - a)$.  Define
$x_n = a + n \Delta x$ and $k_m = k_0 + m \Delta k$.</p></li>
<li><p>Discretize the wave-functions on this grid.  Let $\psi_n(t) = \psi(x_n, t)$,
$V_n = V(x_n)$, and $\widetilde{\psi}_m = \widetilde{\psi}(k_m, t)$.</p></li>
<li><p>To progress the system by a time-step $\Delta t$, perform the following:</p>

<ol>
<li><p>Compute a half-step in $x$:
$\psi_n \longleftarrow \psi_n
 \exp[-i (\Delta t / 2) (V_n / \hbar)]$</p></li>
<li><p>Calculate $\widetilde{\psi}_m$ from $\psi_n$ using the FFT.</p></li>
<li><p>Compute a full-step in $k$:
$\widetilde{\psi}_m \longleftarrow \widetilde{\psi}_m
\exp[-i \hbar (k \cdot k) \Delta t / (2 m)]$</p></li>
<li><p>Calculate $\psi_n$ from $\widetilde{\psi}_m$ using the inverse FFT.</p></li>
<li><p>Compute a second half-step in $x$:
$\psi_n \longleftarrow \psi_n
 \exp[-i (\Delta t / 2)(V_n / \hbar)]$</p></li>
</ol>
</li>
<li><p>Repeat step 3 until the desired time is reached.</p></li>
</ol>


<p>Note that we have split the $x$-space time-step into two half-steps: this
turns out to lead to a more stable numerical solution than performing
the step all at once. Those familiar with numerical integration
algorithms may recognize this as an example of the
well-known leap-frog integration technique.</p>

<p>To test this out, I&#8217;ve written a python code which sets up a particle in a
box with a potential barrier.  The barrier is high enough that a classical
particle would be unable to penetrate it.  A quantum particle, however, can
&#8220;tunnel&#8221; through, leading to a non-zero probability of finding the particle
on the other side of the partition.  This quantum tunneling effect lies at
the core of technologies as diverse as electron microsopy, semiconding diodes,
and perhaps even the future of low-powered transistors.</p>

<p>The animation of the result is below (for a brief introduction to the animation
capabilities of python, see
<a href="http://jakevdp.github.com/blog/2012/08/18/matplotlib-animation-tutorial/">this post</a>).
The top panel shows the position-space wave function, while the bottom panel
shows the momentum-space wave function.</p>

<p><video width='360' height='270' preload='none' controls poster=' /downloads/videos/schrodinger_barrier_frame.png'><source src='http://jakevdp.github.com/downloads/videos/schrodinger_barrier.mp4' type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"'/></video></p>

<p>Notice that the height of the potential barrier (denoted by the dashed line in
the bottom panel) is far larger than the energy of the particle.  Still, due
to quantum effects, a small part of the wave function is able to tunnel through
the barrier and reach the other side.</p>

<p>The python code used to generate this animation is included below.  It&#8217;s pretty
long, but I&#8217;ve tried to comment extensively to make the algorithm more clear.
If you&#8217;re so inclined, you might try running the example and adjusting the
potential or the input wave function to see the effect on the dynamics of
the quantum system.</p>

<figure class='code'><figcaption><span>Schrodinger (schrodinger.py)</span> <a href='http://jakevdp.github.com/downloads/code/schrodinger.py'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">General Numerical Solver for the 1D Time-Dependent Schrodinger&#39;s equation.</span>
</span><span class='line'>
</span><span class='line'><span class="sd">author: Jake Vanderplas</span>
</span><span class='line'><span class="sd">email: vanderplas@astro.washington.edu</span>
</span><span class='line'><span class="sd">website: http://jakevdp.github.com</span>
</span><span class='line'><span class="sd">license: BSD</span>
</span><span class='line'><span class="sd">Please feel free to use and modify this, but keep the above information. Thanks!</span>
</span><span class='line'><span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">pl</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">animation</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">scipy.fftpack</span> <span class="kn">import</span> <span class="n">fft</span><span class="p">,</span><span class="n">ifft</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Schrodinger</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">    Class which implements a numerical solution of the time-dependent</span>
</span><span class='line'><span class="sd">    Schrodinger equation for an arbitrary potential</span>
</span><span class='line'><span class="sd">    &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">psi_x0</span><span class="p">,</span> <span class="n">V_x</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">k0</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">hbar</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
</span><span class='line'>        <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">        Parameters</span>
</span><span class='line'><span class="sd">        ----------</span>
</span><span class='line'><span class="sd">        x : array_like, float</span>
</span><span class='line'><span class="sd">            length-N array of evenly spaced spatial coordinates</span>
</span><span class='line'><span class="sd">        psi_x0 : array_like, complex</span>
</span><span class='line'><span class="sd">            length-N array of the initial wave function at time t0</span>
</span><span class='line'><span class="sd">        V_x : array_like, float</span>
</span><span class='line'><span class="sd">             length-N array giving the potential at each x</span>
</span><span class='line'><span class="sd">        k0 : float</span>
</span><span class='line'><span class="sd">            the minimum value of k.  Note that, because of the workings of the</span>
</span><span class='line'><span class="sd">            fast fourier transform, the momentum wave-number will be defined</span>
</span><span class='line'><span class="sd">            in the range</span>
</span><span class='line'><span class="sd">              k0 &lt; k &lt; 2*pi / dx</span>
</span><span class='line'><span class="sd">            where dx = x[1]-x[0].  If you expect nonzero momentum outside this</span>
</span><span class='line'><span class="sd">            range, you must modify the inputs accordingly.  If not specified,</span>
</span><span class='line'><span class="sd">            k0 will be calculated such that the range is [-k0,k0]</span>
</span><span class='line'><span class="sd">        hbar : float</span>
</span><span class='line'><span class="sd">            value of planck&#39;s constant (default = 1)</span>
</span><span class='line'><span class="sd">        m : float</span>
</span><span class='line'><span class="sd">            particle mass (default = 1)</span>
</span><span class='line'><span class="sd">        t0 : float</span>
</span><span class='line'><span class="sd">            initial tile (default = 0)</span>
</span><span class='line'><span class="sd">        &quot;&quot;&quot;</span>
</span><span class='line'>        <span class="c"># Validation of array inputs</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">psi_x0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_x</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">psi_x0</span><span class="p">,</span> <span class="n">V_x</span><span class="p">))</span>
</span><span class='line'>        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span><span class="p">,)</span>
</span><span class='line'>        <span class="k">assert</span> <span class="n">psi_x0</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span><span class="p">,)</span>
</span><span class='line'>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span><span class="p">,)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># Set internal parameters</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">hbar</span> <span class="o">=</span> <span class="n">hbar</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t0</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">dt_</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">dk</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># set momentum scale</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">k0</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">k0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dk</span>
</span><span class='line'>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">k0</span> <span class="o">=</span> <span class="n">k0</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dk</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">psi_x</span> <span class="o">=</span> <span class="n">psi_x0</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">compute_k_from_x</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># variables which hold steps in evolution of the</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">x_evolve_half</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">x_evolve</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">k_evolve</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># attributes used for dynamic plotting</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">psi_x_line</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">psi_k_line</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">V_x_line</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_set_psi_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psi_x</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">psi_mod_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi_x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'>                          <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_get_psi_x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_mod_x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'>                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_set_psi_k</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psi_k</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">psi_mod_k</span> <span class="o">=</span> <span class="n">psi_k</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>                                        <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dk</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_get_psi_k</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_mod_k</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span>
</span><span class='line'>                                        <span class="bp">self</span><span class="o">.</span><span class="n">dk</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_get_dt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_set_dt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">dt</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">dt_</span> <span class="o">=</span> <span class="n">dt</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">x_evolve_half</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="mi">1j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_x</span>
</span><span class='line'>                                         <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">hbar</span> <span class="o">*</span> <span class="n">dt</span> <span class="p">)</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">x_evolve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_evolve_half</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_evolve_half</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">k_evolve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="mi">1j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">hbar</span> <span class="o">/</span>
</span><span class='line'>                                    <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">psi_x</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_psi_x</span><span class="p">,</span> <span class="n">_set_psi_x</span><span class="p">)</span>
</span><span class='line'>    <span class="n">psi_k</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_psi_k</span><span class="p">,</span> <span class="n">_set_psi_k</span><span class="p">)</span>
</span><span class='line'>    <span class="n">dt</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_dt</span><span class="p">,</span> <span class="n">_set_dt</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">compute_k_from_x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">psi_mod_k</span> <span class="o">=</span> <span class="n">fft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_mod_x</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">compute_x_from_k</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">psi_mod_x</span> <span class="o">=</span> <span class="n">ifft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_mod_k</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">Nsteps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
</span><span class='line'>        <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">        Perform a series of time-steps via the time-dependent</span>
</span><span class='line'><span class="sd">        Schrodinger Equation.</span>
</span><span class='line'>
</span><span class='line'><span class="sd">        Parameters</span>
</span><span class='line'><span class="sd">        ----------</span>
</span><span class='line'><span class="sd">        dt : float</span>
</span><span class='line'><span class="sd">            the small time interval over which to integrate</span>
</span><span class='line'><span class="sd">        Nsteps : float, optional</span>
</span><span class='line'><span class="sd">            the number of intervals to compute.  The total change</span>
</span><span class='line'><span class="sd">            in time at the end of this method will be dt * Nsteps.</span>
</span><span class='line'><span class="sd">            default is N = 1</span>
</span><span class='line'><span class="sd">        &quot;&quot;&quot;</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">Nsteps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">psi_mod_x</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_evolve_half</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">Nsteps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">compute_k_from_x</span><span class="p">()</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">psi_mod_k</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_evolve</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">compute_x_from_k</span><span class="p">()</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">psi_mod_x</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_evolve</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">compute_k_from_x</span><span class="p">()</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">psi_mod_k</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_evolve</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">compute_x_from_k</span><span class="p">()</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">psi_mod_x</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_evolve_half</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">compute_k_from_x</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">Nsteps</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">######################################################################</span>
</span><span class='line'><span class="c"># Helper functions for gaussian wave-packets</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">gauss_x</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">k0</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">    a gaussian wave packet of width a, centered at x0, with momentum k0</span>
</span><span class='line'><span class="sd">    &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">((</span><span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
</span><span class='line'>            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">a</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1j</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">k0</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">gauss_k</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">k0</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">    analytical fourier transform of gauss_x(x), above</span>
</span><span class='line'><span class="sd">    &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">((</span><span class="n">a</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
</span><span class='line'>            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="n">k0</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1j</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="n">k0</span><span class="p">)</span> <span class="o">*</span> <span class="n">x0</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">######################################################################</span>
</span><span class='line'><span class="c"># Utility functions for running the animation</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">theta</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">    theta function :</span>
</span><span class='line'><span class="sd">      returns 0 if x&lt;=0, and 1 if x&gt;0</span>
</span><span class='line'><span class="sd">    &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'>    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span class='line'>    <span class="n">y</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">y</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">square_barrier</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">height</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">theta</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c">######################################################################</span>
</span><span class='line'><span class="c"># Create the animation</span>
</span><span class='line'>
</span><span class='line'><span class="c"># specify time steps and duration</span>
</span><span class='line'><span class="n">dt</span> <span class="o">=</span> <span class="mf">0.01</span>
</span><span class='line'><span class="n">N_steps</span> <span class="o">=</span> <span class="mi">50</span>
</span><span class='line'><span class="n">t_max</span> <span class="o">=</span> <span class="mi">120</span>
</span><span class='line'><span class="n">frames</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t_max</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">N_steps</span> <span class="o">*</span> <span class="n">dt</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c"># specify constants</span>
</span><span class='line'><span class="n">hbar</span> <span class="o">=</span> <span class="mf">1.0</span>   <span class="c"># planck&#39;s constant</span>
</span><span class='line'><span class="n">m</span> <span class="o">=</span> <span class="mf">1.9</span>      <span class="c"># particle mass</span>
</span><span class='line'>
</span><span class='line'><span class="c"># specify range in x coordinate</span>
</span><span class='line'><span class="n">N</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">11</span>
</span><span class='line'><span class="n">dx</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span class='line'><span class="n">x</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># specify potential</span>
</span><span class='line'><span class="n">V0</span> <span class="o">=</span> <span class="mf">1.5</span>
</span><span class='line'><span class="n">L</span> <span class="o">=</span> <span class="n">hbar</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">V0</span><span class="p">)</span>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">L</span>
</span><span class='line'><span class="n">x0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">60</span> <span class="o">*</span> <span class="n">L</span>
</span><span class='line'><span class="n">V_x</span> <span class="o">=</span> <span class="n">square_barrier</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">V0</span><span class="p">)</span>
</span><span class='line'><span class="n">V_x</span><span class="p">[</span><span class="n">x</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">98</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1E6</span>
</span><span class='line'><span class="n">V_x</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">98</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1E6</span>
</span><span class='line'>
</span><span class='line'><span class="c"># specify initial momentum and quantities derived from it</span>
</span><span class='line'><span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">V0</span><span class="p">)</span>
</span><span class='line'><span class="n">dp2</span> <span class="o">=</span> <span class="n">p0</span> <span class="o">*</span> <span class="n">p0</span> <span class="o">*</span> <span class="mf">1.</span><span class="o">/</span><span class="mi">80</span>
</span><span class='line'><span class="n">d</span> <span class="o">=</span> <span class="n">hbar</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dp2</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">k0</span> <span class="o">=</span> <span class="n">p0</span> <span class="o">/</span> <span class="n">hbar</span>
</span><span class='line'><span class="n">v0</span> <span class="o">=</span> <span class="n">p0</span> <span class="o">/</span> <span class="n">m</span>
</span><span class='line'><span class="n">psi_x0</span> <span class="o">=</span> <span class="n">gauss_x</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">k0</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># define the Schrodinger object which performs the calculations</span>
</span><span class='line'><span class="n">S</span> <span class="o">=</span> <span class="n">Schrodinger</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
</span><span class='line'>                <span class="n">psi_x0</span><span class="o">=</span><span class="n">psi_x0</span><span class="p">,</span>
</span><span class='line'>                <span class="n">V_x</span><span class="o">=</span><span class="n">V_x</span><span class="p">,</span>
</span><span class='line'>                <span class="n">hbar</span><span class="o">=</span><span class="n">hbar</span><span class="p">,</span>
</span><span class='line'>                <span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
</span><span class='line'>                <span class="n">k0</span><span class="o">=-</span><span class="mi">28</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c">######################################################################</span>
</span><span class='line'><span class="c"># Set up plot</span>
</span><span class='line'><span class="n">fig</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c"># plotting limits</span>
</span><span class='line'><span class="n">xlim</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</span><span class='line'><span class="n">klim</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># top axes show the x-space data</span>
</span><span class='line'><span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">ymax</span> <span class="o">=</span> <span class="n">V0</span>
</span><span class='line'><span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="n">ymin</span> <span class="o">-</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">),</span>
</span><span class='line'>                            <span class="n">ymax</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)))</span>
</span><span class='line'><span class="n">psi_x_line</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">r&#39;$|\psi(x)|$&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">V_x_line</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">r&#39;$V(x)$&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">center_line</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;:&#39;</span><span class="p">,</span>
</span><span class='line'>                          <span class="n">label</span> <span class="o">=</span> <span class="s">r&quot;$x_0 + v_0t$&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">title</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">))</span>
</span><span class='line'><span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;$x$&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;$|\psi(x)|$&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># bottom axes show the k-space data</span>
</span><span class='line'><span class="n">ymin</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">psi_k</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span class='line'><span class="n">ymax</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">psi_k</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span class='line'><span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">klim</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="n">ymin</span> <span class="o">-</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">),</span>
</span><span class='line'>                            <span class="n">ymax</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)))</span>
</span><span class='line'><span class="n">psi_k_line</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">r&#39;$|\psi(k)|$&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">p0_line1</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="o">-</span><span class="n">p0</span> <span class="o">/</span> <span class="n">hbar</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">r&#39;$\pm p_0$&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">p0_line2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">p0</span> <span class="o">/</span> <span class="n">hbar</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">mV_line</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">V0</span><span class="p">)</span> <span class="o">/</span> <span class="n">hbar</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;--&#39;</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">label</span><span class="o">=</span><span class="s">r&#39;$\sqrt{2mV_0}$&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">))</span>
</span><span class='line'><span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;$k$&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;$|\psi(k)|$&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">V_x_line</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">V_x</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c">######################################################################</span>
</span><span class='line'><span class="c"># Animate plot</span>
</span><span class='line'><span class="k">def</span> <span class="nf">init</span><span class="p">():</span>
</span><span class='line'>    <span class="n">psi_x_line</span><span class="o">.</span><span class="n">set_data</span><span class="p">([],</span> <span class="p">[])</span>
</span><span class='line'>    <span class="n">V_x_line</span><span class="o">.</span><span class="n">set_data</span><span class="p">([],</span> <span class="p">[])</span>
</span><span class='line'>    <span class="n">center_line</span><span class="o">.</span><span class="n">set_data</span><span class="p">([],</span> <span class="p">[])</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">psi_k_line</span><span class="o">.</span><span class="n">set_data</span><span class="p">([],</span> <span class="p">[])</span>
</span><span class='line'>    <span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span><span class="n">psi_x_line</span><span class="p">,</span> <span class="n">V_x_line</span><span class="p">,</span> <span class="n">center_line</span><span class="p">,</span> <span class="n">psi_k_line</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span class='line'>    <span class="n">S</span><span class="o">.</span><span class="n">time_step</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">N_steps</span><span class="p">)</span>
</span><span class='line'>    <span class="n">psi_x_line</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">psi_x</span><span class="p">))</span>
</span><span class='line'>    <span class="n">V_x_line</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">V_x</span><span class="p">)</span>
</span><span class='line'>    <span class="n">center_line</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">[</span><span class="n">x0</span> <span class="o">+</span> <span class="n">S</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">p0</span> <span class="o">/</span> <span class="n">m</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">psi_k_line</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">psi_k</span><span class="p">))</span>
</span><span class='line'>    <span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s">&quot;t = </span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">S</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span><span class="n">psi_x_line</span><span class="p">,</span> <span class="n">V_x_line</span><span class="p">,</span> <span class="n">center_line</span><span class="p">,</span> <span class="n">psi_k_line</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># call the animator.  blit=True means only re-draw the parts that have changed.</span>
</span><span class='line'><span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">init_func</span><span class="o">=</span><span class="n">init</span><span class="p">,</span>
</span><span class='line'>                               <span class="n">frames</span><span class="o">=</span><span class="n">frames</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">blit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># uncomment the following line to save the video in mp4 format.  This</span>
</span><span class='line'><span class="c"># requires either mencoder or ffmpeg to be installed on your system</span>
</span><span class='line'>
</span><span class='line'><span class="c">#anim.save(&#39;schrodinger_barrier.mp4&#39;, fps=15, extra_args=[&#39;-vcodec&#39;, &#39;libx264&#39;])</span>
</span><span class='line'>
</span><span class='line'><span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Edit: I changed the legend font properties to play nicely with older
 matplotlib versions.  Thanks to Yann for pointing it out.</em></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Numba vs Cython]]></title>
    <link href="http://jakevdp.github.com/blog/2012/08/24/numba-vs-cython/"/>
    <updated>2012-08-24T10:41:00-07:00</updated>
    <id>http://jakevdp.github.com/blog/2012/08/24/numba-vs-cython</id>
    <content type="html"><![CDATA[<p>Often I&#8217;ll tell people that I use python for computational analysis, and they
look at me inquisitively.  &#8220;Isn&#8217;t python pretty slow?&#8221;  They have a point.
Python is an interpreted language, and as such cannot natively perform
many operations as quickly as a compiled language such as C or Fortran.
There is also the issue of the oft-misunderstood and much-maligned
<a href="http://wiki.python.org/moin/GlobalInterpreterLock">GIL</a>,
which calls into question python&#8217;s ability to allow true parallel computing.</p>

<p>Many solutions have been proposed: <a href="http://pypy.org/">PyPy</a> is a much faster
version of the core python language;
<a href="http://code.google.com/p/numexpr/">numexpr</a> provides optimized performance
on certain classes of operations from within python;
<a href="http://www.scipy.org/Weave/">weave</a> allows inline inclusion of compiled
C/C++ code;
<a href="http://www.cython.org/">cython</a> provides extra markup that allows python
and/or python-like code to be compiled into C for fast operations.  But
a naysayer might point out: many of these &#8220;python&#8221; solutions in practice
are not really python at all, but clever hacks into Fortran or C.</p>

<!-- more -->


<p>I personally have no problem with this. I like python because it gives me a nice
work-flow: it has a clean syntax, I don&#8217;t need to spend my time hunting down
memory errors, it&#8217;s quick to try-out code snippets, it&#8217;s easy to wrap legacy
code written in C and Fortran, and I&#8217;m much more productive when writing
python vs writing C or C++.  <a href="http://numpy.scipy.org">Numpy</a>,
<a href="http://www.scipy.org">scipy</a>, and <a href="http://www.scikit-learn.org">scikit-learn</a>
give me optimized routines for most of what I need to do on a daily basis,
and if something more specialized comes up, cython has never failed me.
Nevertheless, the whole setup is a bit clunky:
why can&#8217;t I have the best of both worlds: a beautiful, scripted, dynamically
typed language like python, with the speed of C or Fortran?</p>

<p>In recent years, new languages like <a href="http://golang.org/">go</a> and
<a href="http://julialang.org/">julia</a> have popped up which try to address some of
these issues.  Julia in particular has a number of nice properties (see the
<a href="http://www.youtube.com/watch?v=VCp1jUgVRgE">talk</a> from Scipy 2012 for a
good introduction) and uses <a href="http://llvm.org">LLVM</a> to enable just-in-time
(JIT) compilation and achieve some impressive benchmarks.  Julia holds promise,
but I&#8217;m not yet ready to abandon the incredible code-base and user-base
of the python community.</p>

<p>Enter <a href="http://numba.pydata.org/">numba</a>.  This is an attempt to bring JIT
compilation cleanly to python, using the LLVM framework.  In a
<a href="http://jakevdp.github.com/blog/2012/08/08/memoryview-benchmarks/">recent post</a>, one commenter pointed
out numba as an alternative to cython.  I had heard about it before (See
Travis Oliphant&#8217;s scipy 2012 talk
<a href="http://www.youtube.com/watch?v=WYi1cymszqY">here</a>) but hadn&#8217;t had the chance
to try it out until now. Installation is a bit involved, but the directions
on the <a href="http://numba.pydata.org/">numba website</a> are pretty good.</p>

<p>To test this out, I decided to run some benchmarks using the
pairwise distance function I&#8217;ve explored before (see posts
<a href="http://jakevdp.github.com/blog/2012/08/08/memoryview-benchmarks/">here</a>
and <a href="http://jakevdp.github.com/blog/2012/08/16/memoryview-benchmarks-2/">here</a>).</p>

<h3>Pure Python Version</h3>

<p>The pure python version of the function looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">pairwise_python</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">):</span>
</span><span class='line'>    <span class="n">M</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>    <span class="n">N</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
</span><span class='line'>            <span class="n">d</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span class='line'>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
</span><span class='line'>                <span class="n">tmp</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
</span><span class='line'>                <span class="n">d</span> <span class="o">+=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">tmp</span>
</span><span class='line'>            <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not surprisingly, this is very slow.  For an array consisting of 1000 points
in three dimensions, execution takes over 12 seconds on my machine:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class='line'><span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span class='line'><span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>
</span><span class='line'><span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">pairwise_python</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span class='line'><span class="mi">1</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">12.1</span> <span class="n">s</span> <span class="n">per</span> <span class="n">loop</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Numba Version</h3>

<p>Once numba is installed, we add only a single line to our above definition
to allow numba to interface our code with LLVM:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">double</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">numba.decorators</span> <span class="kn">import</span> <span class="n">jit</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@jit</span><span class="p">(</span><span class="n">arg_types</span><span class="o">=</span><span class="p">[</span><span class="n">double</span><span class="p">[:,:],</span> <span class="n">double</span><span class="p">[:,:]])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">pairwise_numba</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">):</span>
</span><span class='line'>    <span class="n">M</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>    <span class="n">N</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
</span><span class='line'>            <span class="n">d</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span class='line'>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
</span><span class='line'>                <span class="n">tmp</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
</span><span class='line'>                <span class="n">d</span> <span class="o">+=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">tmp</span>
</span><span class='line'>            <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>I should emphasize that this is the <em>exact same</em> code, except for numba&#8217;s
<code>jit</code> decorator.  The results are pretty astonishing:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class='line'><span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span class='line'><span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>
</span><span class='line'><span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">pairwise_numba</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span class='line'><span class="mi">100</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">15.5</span> <span class="n">ms</span> <span class="n">per</span> <span class="n">loop</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is a three order-of-magnitude speedup, simply by adding a numba
decorator!</p>

<h3>Cython Version</h3>

<p>For completeness, let&#8217;s do the same thing in cython.  Cython
takes a bit more than just some decorators: there are also type specifiers
and other imports required.  Additionally, we&#8217;ll use the <code>sqrt</code> function
from the C math library rather than from numpy.  Here&#8217;s the code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='cython'><span class='line'><span class="k">cimport</span> <span class="nn">cython</span>
</span><span class='line'><span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">sqrt</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">pairwise_cython</span><span class="p">(</span><span class="n">double</span><span class="p">[:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">X</span><span class="p">,</span> <span class="n">double</span><span class="p">[:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">D</span><span class="p">):</span>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">M</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">N</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">tmp</span><span class="p">,</span> <span class="nf">d</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
</span><span class='line'>            <span class="n">d</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span class='line'>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
</span><span class='line'>                <span class="n">tmp</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
</span><span class='line'>                <span class="n">d</span> <span class="o">+=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">tmp</span>
</span><span class='line'>            <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running this shows about a 30% speedup over numba:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='cython'><span class='line'><span class="n">In</span> <span class="p">[</span><span class="mf">2</span><span class="p">]:</span> <span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span class='line'><span class="n">In</span> <span class="p">[</span><span class="mf">3</span><span class="p">]:</span> <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mf">1000</span><span class="p">,</span> <span class="mf">3</span><span class="p">))</span>
</span><span class='line'><span class="n">In</span> <span class="p">[</span><span class="mf">4</span><span class="p">]:</span> <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mf">1000</span><span class="p">,</span> <span class="mf">1000</span><span class="p">))</span>
</span><span class='line'><span class="n">In</span> <span class="p">[</span><span class="mf">5</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">pairwise_numba</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span class='line'><span class="mf">100</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mf">3</span><span class="p">:</span> <span class="mf">9.86</span> <span class="n">ms</span> <span class="n">per</span> <span class="n">loop</span>
</span></code></pre></td></tr></table></div></figure>


<h3>The Takeaway</h3>

<p>So numba is 1000 times faster than a pure python implementation, and only
marginally slower than nearly identical cython code.
There are some caveats here: first of all, I have years of experience with
cython, and only an hour&#8217;s experience with numba.  I&#8217;ve used every optimization
I know for the cython version, and just the basic vanilla syntax for numba.
There are likely ways to tweak the numba version to make it even faster,
as indicated in the comments of
<a href="http://jakevdp.github.com/blog/2012/08/08/memoryview-benchmarks/">this post</a>.</p>

<p>All in all, I should say I&#8217;m very impressed.  Using numba, I added
just a <em>single line</em> to the original python code, and
was able to attain speeds competetive with a highly-optimized (and
significantly less &#8220;pythonic&#8221;)  cython implementation.  Based on this,
I&#8217;m extremely excited to see what numba brings in the future.</p>

<p>All the above code is available as an ipython notebook:
<a href="http://jakevdp.github.com/downloads/notebooks/numba_vs_cython.ipynb">numba_vs_cython.ipynb</a>.
For information on how to view this file, see the
<a href="http://ipython.org/ipython-doc/dev/interactive/htmlnotebook.html">IPython page</a>
Alternatively, you can view this notebook (but not modify it) using the
nbviewer <a href="http://nbviewer.ipython.org/url/jakevdp.github.com/downloads/notebooks/numba_vs_cython.ipynb">here</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Matplotlib Animation Tutorial]]></title>
    <link href="http://jakevdp.github.com/blog/2012/08/18/matplotlib-animation-tutorial/"/>
    <updated>2012-08-18T08:01:00-07:00</updated>
    <id>http://jakevdp.github.com/blog/2012/08/18/matplotlib-animation-tutorial</id>
    <content type="html"><![CDATA[<p><a href="http://matplotlib.sourceforge.net">Matplotlib</a> version 1.1 added some tools
for creating
<a href="http://matplotlib.sourceforge.net/api/animation_api.html">animations</a>
which are really slick.  You can find some good example animations on
the matplotlib
<a href="http://matplotlib.sourceforge.net/examples/animation/index.html">examples</a>
page.  I thought I&#8217;d share here some of the things I&#8217;ve learned when playing
around with these tools.</p>

<h3>Basic Animation</h3>

<p>The animation tools center around the <code>matplotlib.animation.Animation</code> base
class, which provides a framework around which the animation functionality
is built.  The main interfaces are <code>TimedAnimation</code> and <code>FuncAnimation</code>,
which you can read more about in the
<a href="http://matplotlib.sourceforge.net/api/animation_api.html">documentation</a>.
Here I&#8217;ll explore using the <code>FuncAnimation</code> tool, which I have found
to be the most useful.</p>

<!-- more -->


<p>First we&#8217;ll use <code>FuncAnimation</code> to do a basic animation of a sine wave moving
across the screen:</p>

<figure class='code'><figcaption><span>Basic Animation (basic_animation.py)</span> <a href='http://jakevdp.github.com/downloads/code/basic_animation.py'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">Matplotlib Animation Example</span>
</span><span class='line'>
</span><span class='line'><span class="sd">author: Jake Vanderplas</span>
</span><span class='line'><span class="sd">email: vanderplas@astro.washington.edu</span>
</span><span class='line'><span class="sd">website: http://jakevdp.github.com</span>
</span><span class='line'><span class="sd">license: BSD</span>
</span><span class='line'><span class="sd">Please feel free to use and modify this, but keep the above information. Thanks!</span>
</span><span class='line'><span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">animation</span>
</span><span class='line'>
</span><span class='line'><span class="c"># First set up the figure, the axis, and the plot element we want to animate</span>
</span><span class='line'><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
</span><span class='line'><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span><span class='line'><span class="n">line</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># initialization function: plot the background of each frame</span>
</span><span class='line'><span class="k">def</span> <span class="nf">init</span><span class="p">():</span>
</span><span class='line'>    <span class="n">line</span><span class="o">.</span><span class="n">set_data</span><span class="p">([],</span> <span class="p">[])</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">line</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'><span class="c"># animation function.  This is called sequentially</span>
</span><span class='line'><span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span class='line'>    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</span><span class='line'>    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">i</span><span class="p">))</span>
</span><span class='line'>    <span class="n">line</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">line</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'><span class="c"># call the animator.  blit=True means only re-draw the parts that have changed.</span>
</span><span class='line'><span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">init_func</span><span class="o">=</span><span class="n">init</span><span class="p">,</span>
</span><span class='line'>                               <span class="n">frames</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">blit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># save the animation as an mp4.  This requires ffmpeg or mencoder to be</span>
</span><span class='line'><span class="c"># installed.  The extra_args ensure that the x264 codec is used, so that</span>
</span><span class='line'><span class="c"># the video can be embedded in html5.  You may need to adjust this for</span>
</span><span class='line'><span class="c"># your system: for more information, see</span>
</span><span class='line'><span class="c"># http://matplotlib.sourceforge.net/api/animation_api.html</span>
</span><span class='line'><span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;basic_animation.mp4&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;-vcodec&#39;</span><span class="p">,</span> <span class="s">&#39;libx264&#39;</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&#8217;s step through this and see what&#8217;s going on.  After importing required
pieces of <code>numpy</code> and <code>matplotlib</code>, The script sets up the plot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
</span><span class='line'><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span><span class='line'><span class="n">line</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we create a figure window, create a single axis in the figure, and then
create our line object which will be modified in the animation.  Note that
here we simply plot an empty line: we&#8217;ll add data to the line later.</p>

<p>Next we&#8217;ll create the functions which make the animation happen.  <code>init()</code>
is the function which will be called to create the base frame upon which
the animation takes place.  Here we use just a simple function which sets
the line data to nothing.  It is important that this function return the
line object, because this tells the animator which objects on the plot to
update after each frame:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">init</span><span class="p">():</span>
</span><span class='line'>    <span class="n">line</span><span class="o">.</span><span class="n">set_data</span><span class="p">([],</span> <span class="p">[])</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">line</span><span class="p">,</span>
</span></code></pre></td></tr></table></div></figure>


<p>The next piece is the animation function.  It takes a single parameter, the
frame number <code>i</code>, and draws a sine wave with a shift that depends on <code>i</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># animation function.  This is called sequentially</span>
</span><span class='line'><span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span class='line'>    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</span><span class='line'>    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">i</span><span class="p">))</span>
</span><span class='line'>    <span class="n">line</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">line</span><span class="p">,</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that again here we return a tuple of the plot objects which have been
modified.  This tells the animation framework what parts of the plot should
be animated.</p>

<p>Finally, we create the animation object:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">init_func</span><span class="o">=</span><span class="n">init</span><span class="p">,</span>
</span><span class='line'>                               <span class="n">frames</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">blit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This object needs to persist, so it must be assigned to a variable.  We&#8217;ve
chosen a 100 frame animation with a 20ms delay between frames.  The
<code>blit</code> keyword is an important one: this tells the animation to only re-draw
the pieces of the plot which have changed.  The time saved with <code>blit=True</code>
means that the animations display much more quickly.</p>

<p>We end with an optional save command, and then a show command to show the
result.  Here&#8217;s what the script generates:
<video width='360' height='270' preload='none' controls poster=' /downloads/videos/basic_animation_frame.png'><source src='http://jakevdp.github.com/downloads/videos/basic_animation.mp4' type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"'/></video></p>

<p>This framework for generating and saving animations is very powerful and
flexible: if we put some physics into the <code>animate</code> function, the possibilities
are endless.  Below are a couple examples of some physics animations that
I&#8217;ve been playing around with.</p>

<h3>Double Pendulum</h3>

<p>One of the examples provided on the matplotlib
<a href="http://matplotlib.sourceforge.net/examples/animation/index.html">example page</a>
is an animation of a double pendulum.  This example operates by precomputing
the pendulum position over 10 seconds, and then animating the results.  I
saw this and wondered if python would be fast enough to compute the dynamics
on the fly.  It turns out it is:</p>

<figure class='code'><figcaption><span>Double Pendulum (double_pendulum.py)</span> <a href='http://jakevdp.github.com/downloads/code/double_pendulum.py'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">General Numerical Solver for the 1D Time-Dependent Schrodinger&#39;s equation.</span>
</span><span class='line'>
</span><span class='line'><span class="sd">adapted from code at http://matplotlib.sourceforge.net/examples/animation/double_pendulum_animated.py</span>
</span><span class='line'>
</span><span class='line'><span class="sd">Double pendulum formula translated from the C code at</span>
</span><span class='line'><span class="sd">http://www.physics.usyd.edu.au/~wheat/dpend_html/solve_dpend.c</span>
</span><span class='line'>
</span><span class='line'><span class="sd">author: Jake Vanderplas</span>
</span><span class='line'><span class="sd">email: vanderplas@astro.washington.edu</span>
</span><span class='line'><span class="sd">website: http://jakevdp.github.com</span>
</span><span class='line'><span class="sd">license: BSD</span>
</span><span class='line'><span class="sd">Please feel free to use and modify this, but keep the above information. Thanks!</span>
</span><span class='line'><span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">scipy.integrate</span> <span class="kn">as</span> <span class="nn">integrate</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">matplotlib.animation</span> <span class="kn">as</span> <span class="nn">animation</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">DoublePendulum</span><span class="p">:</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;Double Pendulum Class</span>
</span><span class='line'>
</span><span class='line'><span class="sd">    init_state is [theta1, omega1, theta2, omega2] in degrees,</span>
</span><span class='line'><span class="sd">    where theta1, omega1 is the angular position and velocity of the first</span>
</span><span class='line'><span class="sd">    pendulum arm, and theta2, omega2 is that of the second pendulum arm</span>
</span><span class='line'><span class="sd">    &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span><span class="mi">120</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span class='line'>                 <span class="n">L1</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>  <span class="c"># length of pendulum 1 in m</span>
</span><span class='line'>                 <span class="n">L2</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>  <span class="c"># length of pendulum 2 in m</span>
</span><span class='line'>                 <span class="n">M1</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>  <span class="c"># mass of pendulum 1 in kg</span>
</span><span class='line'>                 <span class="n">M2</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>  <span class="c"># mass of pendulum 2 in kg</span>
</span><span class='line'>                 <span class="n">G</span><span class="o">=</span><span class="mf">9.8</span><span class="p">,</span>  <span class="c"># acceleration due to gravity, in m/s^2</span>
</span><span class='line'>                 <span class="n">origin</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">init_state</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;float&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">L1</span><span class="p">,</span> <span class="n">L2</span><span class="p">,</span> <span class="n">M1</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">G</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">time_elapsed</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="sd">&quot;&quot;&quot;compute the current x,y positions of the pendulum arms&quot;&quot;&quot;</span>
</span><span class='line'>        <span class="p">(</span><span class="n">L1</span><span class="p">,</span> <span class="n">L2</span><span class="p">,</span> <span class="n">M1</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">G</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span class='line'>                       <span class="n">L1</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span class='line'>                       <span class="n">L2</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">])])</span>
</span><span class='line'>        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span class='line'>                       <span class="o">-</span><span class="n">L1</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span class='line'>                       <span class="o">-</span><span class="n">L2</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">])])</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">energy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="sd">&quot;&quot;&quot;compute the energy of the current state&quot;&quot;&quot;</span>
</span><span class='line'>        <span class="p">(</span><span class="n">L1</span><span class="p">,</span> <span class="n">L2</span><span class="p">,</span> <span class="n">M1</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">G</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">([</span><span class="n">L1</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span class='line'>                       <span class="n">L2</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">])])</span>
</span><span class='line'>        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">([</span><span class="o">-</span><span class="n">L1</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span class='line'>                       <span class="o">-</span><span class="n">L2</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">])])</span>
</span><span class='line'>        <span class="n">vx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">([</span><span class="n">L1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span class='line'>                        <span class="n">L2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">])])</span>
</span><span class='line'>        <span class="n">vy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">([</span><span class="n">L1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span class='line'>                        <span class="n">L2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">])])</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">U</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="p">(</span><span class="n">M1</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">M2</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'>        <span class="n">K</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">M1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vx</span><span class="p">,</span> <span class="n">vx</span><span class="p">)</span> <span class="o">+</span> <span class="n">M2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vy</span><span class="p">,</span> <span class="n">vy</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">U</span> <span class="o">+</span> <span class="n">K</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">dstate_dt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
</span><span class='line'>        <span class="sd">&quot;&quot;&quot;compute the derivative of the given state&quot;&quot;&quot;</span>
</span><span class='line'>        <span class="p">(</span><span class="n">M1</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">L1</span><span class="p">,</span> <span class="n">L2</span><span class="p">,</span> <span class="n">G</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">dydx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span class='line'>        <span class="n">dydx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>        <span class="n">dydx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">cos_delta</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span class='line'>        <span class="n">sin_delta</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">den1</span> <span class="o">=</span> <span class="p">(</span><span class="n">M1</span> <span class="o">+</span> <span class="n">M2</span><span class="p">)</span> <span class="o">*</span> <span class="n">L1</span> <span class="o">-</span> <span class="n">M2</span> <span class="o">*</span> <span class="n">L1</span> <span class="o">*</span> <span class="n">cos_delta</span> <span class="o">*</span> <span class="n">cos_delta</span>
</span><span class='line'>        <span class="n">dydx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">M2</span> <span class="o">*</span> <span class="n">L1</span> <span class="o">*</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_delta</span> <span class="o">*</span> <span class="n">cos_delta</span>
</span><span class='line'>                   <span class="o">+</span> <span class="n">M2</span> <span class="o">*</span> <span class="n">G</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">cos_delta</span>
</span><span class='line'>                   <span class="o">+</span> <span class="n">M2</span> <span class="o">*</span> <span class="n">L2</span> <span class="o">*</span> <span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_delta</span>
</span><span class='line'>                   <span class="o">-</span> <span class="p">(</span><span class="n">M1</span> <span class="o">+</span> <span class="n">M2</span><span class="p">)</span> <span class="o">*</span> <span class="n">G</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">/</span> <span class="n">den1</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">den2</span> <span class="o">=</span> <span class="p">(</span><span class="n">L2</span> <span class="o">/</span> <span class="n">L1</span><span class="p">)</span> <span class="o">*</span> <span class="n">den1</span>
</span><span class='line'>        <span class="n">dydx</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">M2</span> <span class="o">*</span> <span class="n">L2</span> <span class="o">*</span> <span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_delta</span> <span class="o">*</span> <span class="n">cos_delta</span>
</span><span class='line'>                   <span class="o">+</span> <span class="p">(</span><span class="n">M1</span> <span class="o">+</span> <span class="n">M2</span><span class="p">)</span> <span class="o">*</span> <span class="n">G</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">cos_delta</span>
</span><span class='line'>                   <span class="o">-</span> <span class="p">(</span><span class="n">M1</span> <span class="o">+</span> <span class="n">M2</span><span class="p">)</span> <span class="o">*</span> <span class="n">L1</span> <span class="o">*</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_delta</span>
</span><span class='line'>                   <span class="o">-</span> <span class="p">(</span><span class="n">M1</span> <span class="o">+</span> <span class="n">M2</span><span class="p">)</span> <span class="o">*</span> <span class="n">G</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">/</span> <span class="n">den2</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">dydx</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
</span><span class='line'>        <span class="sd">&quot;&quot;&quot;execute one time step of length dt and update state&quot;&quot;&quot;</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">odeint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dstate_dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">dt</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">time_elapsed</span> <span class="o">+=</span> <span class="n">dt</span>
</span><span class='line'>
</span><span class='line'><span class="c">#------------------------------------------------------------</span>
</span><span class='line'><span class="c"># set up initial state and global variables</span>
</span><span class='line'><span class="n">pendulum</span> <span class="o">=</span> <span class="n">DoublePendulum</span><span class="p">([</span><span class="mf">180.</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">20.</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
</span><span class='line'><span class="n">dt</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="mi">30</span> <span class="c"># 30 fps</span>
</span><span class='line'>
</span><span class='line'><span class="c">#------------------------------------------------------------</span>
</span><span class='line'><span class="c"># set up figure and animation</span>
</span><span class='line'><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
</span><span class='line'><span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s">&#39;equal&#39;</span><span class="p">,</span> <span class="n">autoscale_on</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
</span><span class='line'>                     <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span><span class='line'><span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">line</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s">&#39;o-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'><span class="n">time_text</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
</span><span class='line'><span class="n">energy_text</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.90</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">init</span><span class="p">():</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;initialize animation&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="n">line</span><span class="o">.</span><span class="n">set_data</span><span class="p">([],</span> <span class="p">[])</span>
</span><span class='line'>    <span class="n">time_text</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">energy_text</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">line</span><span class="p">,</span> <span class="n">time_text</span><span class="p">,</span> <span class="n">energy_text</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;perform animation step&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">global</span> <span class="n">pendulum</span><span class="p">,</span> <span class="n">dt</span>
</span><span class='line'>    <span class="n">pendulum</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">line</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="o">*</span><span class="n">pendulum</span><span class="o">.</span><span class="n">position</span><span class="p">())</span>
</span><span class='line'>    <span class="n">time_text</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s">&#39;time = </span><span class="si">%.1f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">pendulum</span><span class="o">.</span><span class="n">time_elapsed</span><span class="p">)</span>
</span><span class='line'>    <span class="n">energy_text</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s">&#39;energy = </span><span class="si">%.3f</span><span class="s"> J&#39;</span> <span class="o">%</span> <span class="n">pendulum</span><span class="o">.</span><span class="n">energy</span><span class="p">())</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">line</span><span class="p">,</span> <span class="n">time_text</span><span class="p">,</span> <span class="n">energy_text</span>
</span><span class='line'>
</span><span class='line'><span class="c"># choose the interval based on dt and the time to animate one step</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
</span><span class='line'><span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
</span><span class='line'><span class="n">animate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
</span><span class='line'><span class="n">interval</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">-</span> <span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">ani</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
</span><span class='line'>                              <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span> <span class="n">blit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">init_func</span><span class="o">=</span><span class="n">init</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">ani</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;double_pendulum.mp4&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;-vcodec&#39;</span><span class="p">,</span> <span class="s">&#39;libx264&#39;</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we&#8217;ve created a class which stores the state of the double pendulum
(encoded in the angle of each arm plus the angular velocity of each arm)
and also provides some functions for computing the dynamics.  The animation
functions are the same as above, but we just have a bit more complicated
update function: it not only changes the position of the points, but also
changes the text to keep track of time and energy (energy should be constant
if our math is correct: it&#8217;s comforting that it is).  The video below
lasts only ten seconds, but by running the script you can watch the
pendulum chaotically oscillate until your laptop runs out of power:</p>

<p><video width='360' height='270' preload='none' controls poster=' /downloads/videos/double_pendulum_frame.png'><source src='http://jakevdp.github.com/downloads/videos/double_pendulum.mp4' type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"'/></video></p>

<h3>Particles in a Box</h3>

<p>Another animation I created is the elastic collisions of a group of particles
in a box under the force of gravity.  The collisions are elastic: they conserve
energy and 2D momentum, and the particles bounce realistically off the walls
of the box and fall under the influence of a constant gravitational force:</p>

<figure class='code'><figcaption><span>Particles in a Box (particle_box.py)</span> <a href='http://jakevdp.github.com/downloads/code/particle_box.py'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">Animation of Elastic collisions with Gravity</span>
</span><span class='line'>
</span><span class='line'><span class="sd">author: Jake Vanderplas</span>
</span><span class='line'><span class="sd">email: vanderplas@astro.washington.edu</span>
</span><span class='line'><span class="sd">website: http://jakevdp.github.com</span>
</span><span class='line'><span class="sd">license: BSD</span>
</span><span class='line'><span class="sd">Please feel free to use and modify this, but keep the above information. Thanks!</span>
</span><span class='line'><span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">pdist</span><span class="p">,</span> <span class="n">squareform</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">scipy.integrate</span> <span class="kn">as</span> <span class="nn">integrate</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">matplotlib.animation</span> <span class="kn">as</span> <span class="nn">animation</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ParticleBox</span><span class="p">:</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;Orbits class</span>
</span><span class='line'><span class="sd">    </span>
</span><span class='line'><span class="sd">    init_state is an [N x 4] array, where N is the number of particles:</span>
</span><span class='line'><span class="sd">       [[x1, y1, vx1, vy1],</span>
</span><span class='line'><span class="sd">        [x2, y2, vx2, vy2],</span>
</span><span class='line'><span class="sd">        ...               ]</span>
</span><span class='line'>
</span><span class='line'><span class="sd">    bounds is the size of the box: [xmin, xmax, ymin, ymax]</span>
</span><span class='line'><span class="sd">    &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">init_state</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span class='line'>                               <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
</span><span class='line'>                               <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]],</span>
</span><span class='line'>                 <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
</span><span class='line'>                 <span class="n">size</span> <span class="o">=</span> <span class="mf">0.04</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">M</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">G</span> <span class="o">=</span> <span class="mf">9.8</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">init_state</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">=</span> <span class="n">M</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_state</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">time_elapsed</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">G</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
</span><span class='line'>        <span class="sd">&quot;&quot;&quot;step once by dt seconds&quot;&quot;&quot;</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">time_elapsed</span> <span class="o">+=</span> <span class="n">dt</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># update positions</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># find pairs of particles undergoing a collision</span>
</span><span class='line'>        <span class="n">D</span> <span class="o">=</span> <span class="n">squareform</span><span class="p">(</span><span class="n">pdist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]))</span>
</span><span class='line'>        <span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">D</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span><span class='line'>        <span class="n">unique</span> <span class="o">=</span> <span class="p">(</span><span class="n">ind1</span> <span class="o">&lt;</span> <span class="n">ind2</span><span class="p">)</span>
</span><span class='line'>        <span class="n">ind1</span> <span class="o">=</span> <span class="n">ind1</span><span class="p">[</span><span class="n">unique</span><span class="p">]</span>
</span><span class='line'>        <span class="n">ind2</span> <span class="o">=</span> <span class="n">ind2</span><span class="p">[</span><span class="n">unique</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># update velocities of colliding pairs</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">):</span>
</span><span class='line'>            <span class="c"># mass</span>
</span><span class='line'>            <span class="n">m1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span>
</span><span class='line'>            <span class="n">m2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>            <span class="c"># location vector</span>
</span><span class='line'>            <span class="n">r1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</span><span class='line'>            <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>            <span class="c"># velocity vector</span>
</span><span class='line'>            <span class="n">v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:]</span>
</span><span class='line'>            <span class="n">v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span> <span class="mi">2</span><span class="p">:]</span>
</span><span class='line'>
</span><span class='line'>            <span class="c"># relative location &amp; velocity vectors</span>
</span><span class='line'>            <span class="n">r_rel</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">-</span> <span class="n">r2</span>
</span><span class='line'>            <span class="n">v_rel</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">-</span> <span class="n">v2</span>
</span><span class='line'>
</span><span class='line'>            <span class="c"># momentum vector of the center of mass</span>
</span><span class='line'>            <span class="n">v_cm</span> <span class="o">=</span> <span class="p">(</span><span class="n">m1</span> <span class="o">*</span> <span class="n">v1</span> <span class="o">+</span> <span class="n">m2</span> <span class="o">*</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m1</span> <span class="o">+</span> <span class="n">m2</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="c"># collisions of spheres reflect v_rel over r_rel</span>
</span><span class='line'>            <span class="n">rr_rel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r_rel</span><span class="p">,</span> <span class="n">r_rel</span><span class="p">)</span>
</span><span class='line'>            <span class="n">vr_rel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v_rel</span><span class="p">,</span> <span class="n">r_rel</span><span class="p">)</span>
</span><span class='line'>            <span class="n">v_rel</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">r_rel</span> <span class="o">*</span> <span class="n">vr_rel</span> <span class="o">/</span> <span class="n">rr_rel</span> <span class="o">-</span> <span class="n">v_rel</span>
</span><span class='line'>
</span><span class='line'>            <span class="c"># assign new velocities</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="n">v_cm</span> <span class="o">+</span> <span class="n">v_rel</span> <span class="o">*</span> <span class="n">m2</span> <span class="o">/</span> <span class="p">(</span><span class="n">m1</span> <span class="o">+</span> <span class="n">m2</span><span class="p">)</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="n">v_cm</span> <span class="o">-</span> <span class="n">v_rel</span> <span class="o">*</span> <span class="n">m1</span> <span class="o">/</span> <span class="p">(</span><span class="n">m1</span> <span class="o">+</span> <span class="n">m2</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># check for crossing boundary</span>
</span><span class='line'>        <span class="n">crossed_x1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span><span class='line'>        <span class="n">crossed_x2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span><span class='line'>        <span class="n">crossed_y1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span><span class='line'>        <span class="n">crossed_y2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">crossed_x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">crossed_x2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">crossed_y1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">crossed_y2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">crossed_x1</span> <span class="o">|</span> <span class="n">crossed_x2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">crossed_y1</span> <span class="o">|</span> <span class="n">crossed_y2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># add gravity</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">*</span> <span class="n">dt</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">#------------------------------------------------------------</span>
</span><span class='line'><span class="c"># set up initial state</span>
</span><span class='line'><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="n">init_state</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">50</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span class='line'><span class="n">init_state</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">3.9</span>
</span><span class='line'>
</span><span class='line'><span class="n">box</span> <span class="o">=</span> <span class="n">ParticleBox</span><span class="p">(</span><span class="n">init_state</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
</span><span class='line'><span class="n">dt</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mi">30</span> <span class="c"># 30fps</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">#------------------------------------------------------------</span>
</span><span class='line'><span class="c"># set up figure and animation</span>
</span><span class='line'><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
</span><span class='line'><span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s">&#39;equal&#39;</span><span class="p">,</span> <span class="n">autoscale_on</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
</span><span class='line'>                     <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">3.2</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">2.4</span><span class="p">,</span> <span class="mf">2.4</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c"># particles holds the locations of the particles</span>
</span><span class='line'><span class="n">particles</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s">&#39;bo&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># rect is the box edge</span>
</span><span class='line'><span class="n">rect</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">bounds</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span>
</span><span class='line'>                     <span class="n">box</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">box</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span class='line'>                     <span class="n">box</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">box</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span class='line'>                     <span class="n">ec</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">init</span><span class="p">():</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;initialize animation&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">global</span> <span class="n">box</span><span class="p">,</span> <span class="n">rect</span>
</span><span class='line'>    <span class="n">particles</span><span class="o">.</span><span class="n">set_data</span><span class="p">([],</span> <span class="p">[])</span>
</span><span class='line'>    <span class="n">rect</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">particles</span><span class="p">,</span> <span class="n">rect</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;perform animation step&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">global</span> <span class="n">box</span><span class="p">,</span> <span class="n">rect</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span>
</span><span class='line'>    <span class="n">box</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">dpi</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">box</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_figwidth</span><span class="p">()</span>
</span><span class='line'>             <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xbound</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># update pieces of the animation</span>
</span><span class='line'>    <span class="n">rect</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s">&#39;k&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">particles</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">state</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">box</span><span class="o">.</span><span class="n">state</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
</span><span class='line'>    <span class="n">particles</span><span class="o">.</span><span class="n">set_markersize</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">particles</span><span class="p">,</span> <span class="n">rect</span>
</span><span class='line'>
</span><span class='line'><span class="n">ani</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
</span><span class='line'>                              <span class="n">interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">blit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">init_func</span><span class="o">=</span><span class="n">init</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">ani</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;particle_box.mp4&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;-vcodec&#39;</span><span class="p">,</span> <span class="s">&#39;libx264&#39;</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>The math should be familiar to anyone with a physics background, and the
result is pretty mesmerizing.  I coded this up during a flight, and ended
up just sitting and watching it for about ten minutes.</p>

<p><video width='360' height='270' preload='none' controls poster=' /downloads/videos/particle_box_frame.png'><source src='http://jakevdp.github.com/downloads/videos/particle_box.mp4' type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"'/></video></p>

<p>This is just the beginning: it might be an interesting exercise to add
other elements, like computation of the temperature and pressure to demonstrate
the ideal gas law, or real-time plotting of the velocity distribution to
watch it approach the expected Maxwellian distribution.  It opens up many
possibilities for virtual physics demos&#8230;</p>

<h3>Summing it up</h3>

<p>The matplotlib animation module is an excellent addition to what was already
an excellent package.  I think I&#8217;ve just scratched the surface of what&#8217;s
possible with these tools&#8230; what cool animation ideas can you come up
with?</p>

<p>Edit: in a <a href="http://jakevdp.github.com/blog/2012/09/05/quantum-python">followup post</a>, I show how
these tools can be used to generate an animation of a simple Quantum
Mechanical system.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Memoryview Benchmarks 2]]></title>
    <link href="http://jakevdp.github.com/blog/2012/08/16/memoryview-benchmarks-2/"/>
    <updated>2012-08-16T14:19:00-07:00</updated>
    <id>http://jakevdp.github.com/blog/2012/08/16/memoryview-benchmarks-2</id>
    <content type="html"><![CDATA[<p>In the <a href="http://jakevdp.github.com/blog/2012/08/08/memoryview-benchmarks/">previous post</a>, I explored
how cython typed memoryviews can be used to speed up repeated array
operations.  It became clear that typed memoryviews are superior to
the ndarray syntax for slicing, and as fast as raw pointers for single
element access.  In the comments, Mathieu brought up an interesting
question: is the ndarray syntax as good as typed memoryviews if you&#8217;re
not doing slicing?</p>

<p>The answer turns out to be yes, <em>unless</em> the compiler tries to inline your
function.</p>

<!-- more -->


<h3>Inlined Memoryview</h3>

<p>We&#8217;ll use a slightly simpler benchmark script here for simplicity.  We&#8217;ll
use inlined typed memoryviews for the inner function, and call this function
within an outer loop:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='cython'><span class='line'><span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span class='line'><span class="k">cimport</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span class='line'><span class="k">cimport</span> <span class="nn">cython</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="k">cdef</span> <span class="kr">inline</span> <span class="kt">double</span> <span class="nf">inner_func</span><span class="p">(</span><span class="n">double</span><span class="p">[:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">X</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">X</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span> <span class="mf">0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">loop_1</span><span class="p">(</span><span class="nb">int</span> <span class="n">N</span><span class="p">,</span> <span class="n">switch</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">double</span>[<span class="p">:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mf">100</span><span class="p">,</span> <span class="mf">100</span><span class="p">))</span>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">i</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
</span><span class='line'>        <span class="c"># this should be inlined by the compiler</span>
</span><span class='line'>        <span class="n">inner_func</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The inner function is called <code>N</code> times.  We&#8217;ve used the &#8220;inline&#8221; keyword here:
it turns out this is optional with common compiler optimizations turned on.
<code>gcc</code> and other compilers are smart enough to figure out that this function
should be inlined, even if the cython code doesn&#8217;t mark it as such.  Timing
the function on one million loops gives us our comparison benchmark:</p>

<pre><code>%timeit loop_1(1E6)
100000 loops, best of 3: 10.1 us per loop
</code></pre>

<p>Just over a millisecond to perform this loop one million times.</p>

<h3>Non-inlined Memoryview</h3>

<p>Because the compilers are generally so smart, we actually need to be a bit
clever to make sure our function is <em>not</em> inlined.  We&#8217;ll do that through
a switch statement in the loop call, which selects between two possible
inner functions.  This may seem a bit contrived, but it could come up
in practice: for example, if we wanted to create a KDTree for nearest neighbor
searches which can use one of several distance metrics within a single tree
framework, we might be tempted to try a solution like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='cython'><span class='line'><span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span class='line'><span class="k">cimport</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span class='line'><span class="k">cimport</span> <span class="nn">cython</span>
</span><span class='line'>
</span><span class='line'><span class="k">ctypedef</span> <span class="n">double</span> <span class="p">(</span><span class="o">*</span><span class="n">inner_func_ptr</span><span class="p">)(</span><span class="n">double</span><span class="p">[:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="k">cdef</span> <span class="kt">double</span> <span class="nf">inner_func_1</span><span class="p">(</span><span class="n">double</span><span class="p">[:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">X</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">X</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span> <span class="mf">0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="k">cdef</span> <span class="kt">double</span> <span class="nf">inner_func_2</span><span class="p">(</span><span class="n">double</span><span class="p">[:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">X</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">X</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span> <span class="mf">0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">loop_2</span><span class="p">(</span><span class="nb">int</span> <span class="n">N</span><span class="p">,</span> <span class="n">switch</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
</span><span class='line'>    <span class="c"># use a switch to ensure that inlining can&#39;t happen: compilers</span>
</span><span class='line'>    <span class="c"># are usually smart enough to figure it out otherwise.</span>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">inner_func_ptr</span> <span class="nf">func</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">switch</span><span class="p">:</span>
</span><span class='line'>        <span class="n">func</span> <span class="o">=</span> <span class="n">inner_func_1</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="n">func</span> <span class="o">=</span> <span class="n">inner_func_2</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">double</span>[<span class="p">:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mf">100</span><span class="p">,</span> <span class="mf">100</span><span class="p">))</span>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">i</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
</span><span class='line'>        <span class="n">func</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>By adding the switch function, it means the compiler cannot know at compile
time which of the inner functions will be used in the loop, and they
cannot be inlined.  The timing results are as follows:</p>

<pre><code>%timeit loop_2(1E6)
10 loops, best of 3: 22.9 ms per loop
</code></pre>

<p>Using a non-inlined function makes things significantly slower in this case!
So, if you&#8217;re repeatedly calling a small function, inlining can be <em>very</em>
important for optimal execution times.</p>

<h3>The Problem with ndarray</h3>

<p>It turns out that beyond slicing, the problem with the ndarray type is that
multi-dimensional arrays require relatively expensive buffer checks whenever
a function is called.  This causes similar code with ndarrays to be
significantly slower:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='cython'><span class='line'><span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span class='line'><span class="k">cimport</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span class='line'><span class="k">cimport</span> <span class="nn">cython</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="k">cdef</span> <span class="kr">inline</span> <span class="kt">double</span> <span class="nf">inner_func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">double</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mf">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;c&#39;</span><span class="p">]</span> <span class="n">X</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">X</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span> <span class="mf">0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">loop_3</span><span class="p">(</span><span class="nb">int</span> <span class="n">N</span><span class="p">,</span> <span class="n">switch</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span>[<span class="nf">double</span><span class="p">,</span> <span class="nf">ndim</span><span class="o">=</span><span class="mf">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;c&#39;</span><span class="p">]</span> <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mf">100</span><span class="p">,</span> <span class="mf">100</span><span class="p">))</span>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">i</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
</span><span class='line'>        <span class="n">inner_func</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Compiling this gives the following warning:</p>

<pre><code>warning: Buffer unpacking not optimized away.
</code></pre>

<p>The result of this buffer unpacking in each loop is a much slower execution
time:</p>

<pre><code>%timeit loop_3(1E6)
1 loops, best of 3: 617 ms per loop
</code></pre>

<p>This is about 30 times slower than the non-inlined version of the memoryview,
and 6000 times slower than the inlined memoryview above!
Is there any way around this?
Well, there are two options: raw pointers, or explicit inlining in the
code (that is, copying and pasting your code).  Both options will have
speeds similar to that of the inlined memoryviews, but each solution
is inconvenient in its own way.</p>

<p>So why wouldn&#8217;t you use memoryviews?  Well, several projects strive to
remain compatible with python 2.4 (one example is scipy) and python 2.4 is
not compatible with cython&#8217;s typed memoryviews.  Other projects seek to
remain compatible with earlier cython versions which don&#8217;t support
the relatively new memoryview syntax.
In these situations, one of the two partial solutions above
probably need to be used.  In practice, I have usually resorted to passing
around raw pointers.</p>

<h3>Summary</h3>

<p>Here are the timings we found above:</p>

<ul>
<li>Inlined memoryviews: 0.1 ms</li>
<li>Non-inlined memoryviews: 22.9 ms</li>
<li>Inlined ndarray: 617 ms</li>
</ul>


<p>So we see yet another reason that typed memoryviews are superior to
the ndarray syntax: they not only have very speedy slicing, but also
play well with the compiler&#8217;s inlining optimization.  Granted, these
time differences will be insignificant if your inlined function does
some non-negligible amount of computation, but there may be situations
where this affects things.</p>

<h3>Back to my problem</h3>

<p>If you recall, I started all of this because I wanted to create a binary tree
that can compute pairwise distances with arbitrary distance metrics.  Where
do these results put me?  Not in a great position, it turns out.  Abstracting
out the distance function so that the same machinery can be used with
different functions will lead to speed penalties from the inability to inline.
C++ libraries accomplish this through compile-time conditionals (i.e. templates)
but cython doesn&#8217;t have this capability.  Duplicating the tree
framework with a new hard-coded (and thus inlinable) distance metric may
be the only option.  That, or wrapping a templated C++ implementation.</p>

<p>All of the above scripts are available as an ipython
notebook: <a href="http://jakevdp.github.com/downloads/notebooks/memview_bench_2.ipynb">memview_bench_2.ipynb</a>.
For information on how to view this file, see the
<a href="http://ipython.org/ipython-doc/dev/interactive/htmlnotebook.html">IPython page</a>
Alternatively, you can view this notebook (but not modify it) using the
nbviewer <a href="http://nbviewer.ipython.org/url/jakevdp.github.com/downloads/notebooks/memview_bench_2.ipynb">here</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Memoryview Benchmarks]]></title>
    <link href="http://jakevdp.github.com/blog/2012/08/08/memoryview-benchmarks/"/>
    <updated>2012-08-08T18:50:00-07:00</updated>
    <id>http://jakevdp.github.com/blog/2012/08/08/memoryview-benchmarks</id>
    <content type="html"><![CDATA[<p>There was recently a <a href="https://groups.google.com/forum/?fromgroups#!topic/cython-users/8uuxjB_wbBQ[1-25]" title="cython-users archive">thread</a>
on cython-users which caught my eye.  It has to do with
<a href="http://docs.cython.org/src/userguide/memoryviews.html">memoryviews</a>, a new
way of working with memory buffers in cython.</p>

<p>I&#8217;ve been thinking recently about how to do fast
and flexible memory buffer access in cython.  I contributed the
<a href="http://scikit-learn.org/stable/modules/generated/sklearn.neighbors.BallTree.html">BallTree</a>
implementation for nearest neighbors searching in
<a href="http://www.scikit-learn.org">scikit-learn</a>, and have been actively thinking
about how to make it faster and more flexible, including adding the ability
to specify distance metrics other than euclidean and minkowski.</p>

<p>In order to accomplish this, I&#8217;d like to have a set of distance metric
functions which take two vectors and compute a distance.  There would
be many functions with similar call signatures which could then be
plugged into a code that would iterate over a set of vectors and
compute the appropriate distances.</p>

<!-- more -->


<h3>Pure python version</h3>

<p>In pure python, the implementation described above might look something
like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># memview_bench_v1.py</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">euclidean_distance</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
</span><span class='line'>    <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
</span><span class='line'>    <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>This looks promising.  Let&#8217;s create a function based on this which will compute
the pairwise distance between all points in a matrix (this is similar
to <a href="http://scikit-learn.org/stable/modules/generated/sklearn.metrics.pairwise.pairwise_distances.html">pairwise_distances</a> in scikit-learn or
<a href="http://docs.scipy.org/doc/scipy/reference/generated/scipy.spatial.distance.pdist.html">pdist</a> in scipy).  The simple form of the function might look
like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># memview_bench_v1 (continued)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">pairwise</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">euclidean_distance</span><span class="p">):</span>
</span><span class='line'>    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">n_samples</span><span class="p">,</span> <span class="n">n_dim</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
</span><span class='line'>            <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">D</span>
</span></code></pre></td></tr></table></div></figure>


<p>We could exploit symmetry to reduce the number of computations required, but
we&#8217;ll skip that step for now: this simple version of the function will give
us a good benchmark for comparison with alternatives below.  Using the
<code>timeit</code> magic in ipython, we can learn how fast this implementation is:</p>

<pre><code>In [1]: import numpy as np

In [2]:from memview_bench_v1 import pairwise

In [3]: X = np.random.random((500, 3))

In [4]: timeit pairwise(X)
1 loops, best of 3: 6.51 s per loop
</code></pre>

<p>It takes nearly seven seconds to compute 250,000 distances.  This is much
too slow.</p>

<h3>Cython Speedup</h3>

<p>Perhaps we can speed this up using cython declarations.  Before typed
memoryviews were added in cython 0.16, the way to quickly index numpy
arrays in cython was through the numpy specific syntax, adding type
information to each array that specifies its data type, its dimension, and
its order:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='cython'><span class='line'><span class="c"># memview_bench.pyx</span>
</span><span class='line'><span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span class='line'>
</span><span class='line'><span class="k">cimport</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span class='line'><span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">sqrt</span>
</span><span class='line'><span class="k">cimport</span> <span class="nn">cython</span>
</span><span class='line'>
</span><span class='line'><span class="c"># define a function pointer to a metric</span>
</span><span class='line'><span class="k">ctypedef</span> <span class="n">double</span> <span class="p">(</span><span class="o">*</span><span class="n">metric_ptr</span><span class="p">)(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="k">cdef</span> <span class="kt">double</span> <span class="nf">euclidean_distance</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">double</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mf">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;c&#39;</span><span class="p">]</span> <span class="n">x1</span><span class="p">,</span>
</span><span class='line'>                               <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">double</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mf">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;c&#39;</span><span class="p">]</span> <span class="n">x2</span><span class="p">):</span>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">tmp</span><span class="p">,</span> <span class="nf">d</span>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">intp_t</span> <span class="nf">i</span><span class="p">,</span> <span class="nf">N</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">d</span> <span class="o">=</span> <span class="mf">0</span>
</span><span class='line'>    <span class="n">N</span> <span class="o">=</span> <span class="n">x1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
</span><span class='line'>    <span class="c"># assume x2 has the same shape as x1.  This could be dangerous!</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
</span><span class='line'>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">x2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span class='line'>        <span class="n">d</span> <span class="o">+=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">tmp</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">pairwise</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">double</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mf">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;c&#39;</span><span class="p">]</span> <span class="n">X</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span>
</span><span class='line'>             <span class="n">metric</span> <span class="o">=</span> <span class="s">&#39;euclidean&#39;</span><span class="p">):</span>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">metric_ptr</span> <span class="nf">dist_func</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s">&#39;euclidean&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">dist_func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">euclidean_distance</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;unrecognized metric&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">intp_t</span> <span class="nf">i</span><span class="p">,</span> <span class="nf">j</span><span class="p">,</span> <span class="nf">n_samples</span>
</span><span class='line'>    <span class="n">n_samples</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span>[<span class="nf">double</span><span class="p">,</span> <span class="nf">ndim</span><span class="o">=</span><span class="mf">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;c&#39;</span><span class="p">]</span> <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_samples</span><span class="p">,</span>
</span><span class='line'>                                                            <span class="n">n_samples</span><span class="p">))</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
</span><span class='line'>            <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist_func</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">D</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice that we&#8217;re essentially running the same code, except we have added
type identifiers to speed up function calls and loops.  The <code>mode='c'</code>
argument in the <code>np.ndarray</code> type says that the array is contiguous in
memory, and C-ordered.</p>

<p>For reference, this can be compiled in-place by running
<code>python setup.py build_ext --inplace</code> with the following
setup.py file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># setup.py</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">numpy</span>
</span><span class='line'>
</span><span class='line'><span class="kn">from</span> <span class="nn">distutils.core</span> <span class="kn">import</span> <span class="n">setup</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">distutils.extension</span> <span class="kn">import</span> <span class="n">Extension</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">Cython.Distutils</span> <span class="kn">import</span> <span class="n">build_ext</span>
</span><span class='line'>
</span><span class='line'><span class="n">module</span> <span class="o">=</span> <span class="s">&#39;memview_bench_v2&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">setup</span><span class="p">(</span><span class="n">cmdclass</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;build_ext&#39;</span><span class="p">:</span> <span class="n">build_ext</span><span class="p">},</span>
</span><span class='line'>      <span class="n">name</span><span class="o">=</span><span class="n">module</span><span class="p">,</span>
</span><span class='line'>      <span class="n">version</span><span class="o">=</span><span class="s">&#39;1.0&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="n">ext_modules</span><span class="o">=</span><span class="p">[</span><span class="n">Extension</span><span class="p">(</span><span class="n">module</span><span class="p">,</span>
</span><span class='line'>                             <span class="p">[</span><span class="n">module</span> <span class="o">+</span> <span class="s">&quot;.pyx&quot;</span><span class="p">])],</span>
</span><span class='line'>      <span class="n">include_dirs</span><span class="o">=</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">get_include</span><span class="p">(),</span>
</span><span class='line'>                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">get_include</span><span class="p">(),</span> <span class="s">&#39;numpy&#39;</span><span class="p">)]</span>
</span><span class='line'>      <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&#8217;ll time the resulting function on the same sized array as we did previously:</p>

<pre><code>In [1]: import numpy as np

In [2]: from memview_bench_v2 import pairwise

In [3]: X = np.random.random((500, 3))

In [4]: timeit pairwise(X)
1 loops, best of 3: 668 ms per loop
</code></pre>

<p>That&#8217;s a factor of 10 speedup over the pure python version!  It turns out,
though, that we can do better.  In particular, the slicing operation when
we call <code>X[i]</code> and <code>X[j]</code> must generate a new numpy array each time, which
leads to a lot of python overhead in reference counting, etc.  This is the
reason that the cython team introduced typed memoryviews in cython v0.16.</p>

<h3>Typed Memoryviews</h3>

<p>The equivalent of the above code using typed memoryviews looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='cython'><span class='line'><span class="c"># memview_bench_v3.pyx</span>
</span><span class='line'><span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span class='line'>
</span><span class='line'><span class="k">cimport</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span class='line'><span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">sqrt</span>
</span><span class='line'><span class="k">cimport</span> <span class="nn">cython</span>
</span><span class='line'>
</span><span class='line'><span class="c"># define a function pointer to a metric</span>
</span><span class='line'><span class="k">ctypedef</span> <span class="n">double</span> <span class="p">(</span><span class="o">*</span><span class="n">metric_ptr</span><span class="p">)(</span><span class="n">double</span><span class="p">[::</span><span class="mf">1</span><span class="p">],</span> <span class="n">double</span><span class="p">[::</span><span class="mf">1</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="k">cdef</span> <span class="kt">double</span> <span class="nf">euclidean_distance</span><span class="p">(</span><span class="n">double</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">x1</span><span class="p">,</span>
</span><span class='line'>                               <span class="n">double</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">x2</span><span class="p">):</span>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">tmp</span><span class="p">,</span> <span class="nf">d</span>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">intp_t</span> <span class="nf">i</span><span class="p">,</span> <span class="nf">N</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">d</span> <span class="o">=</span> <span class="mf">0</span>
</span><span class='line'>    <span class="n">N</span> <span class="o">=</span> <span class="n">x1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
</span><span class='line'>    <span class="c"># assume x2 has the same shape as x1.  This could be dangerous!</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
</span><span class='line'>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">x2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span class='line'>        <span class="n">d</span> <span class="o">+=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">tmp</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">pairwise</span><span class="p">(</span><span class="n">double</span><span class="p">[:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">X</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span>
</span><span class='line'>             <span class="n">metric</span> <span class="o">=</span> <span class="s">&#39;euclidean&#39;</span><span class="p">):</span>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">metric_ptr</span> <span class="nf">dist_func</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s">&#39;euclidean&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">dist_func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">euclidean_distance</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;unrecognized metric&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">intp_t</span> <span class="nf">i</span><span class="p">,</span> <span class="nf">j</span><span class="p">,</span> <span class="nf">n_samples</span>
</span><span class='line'>    <span class="n">n_samples</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">double</span>[<span class="p">:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
</span><span class='line'>            <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist_func</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">D</span>
</span></code></pre></td></tr></table></div></figure>


<p>The only change is that instead of using the <code>np.ndarray[...]</code> type specifier,
we use the typed memoryview <code>double[:, ::1]</code> specifier.  The <code>::1</code> in the
second position means that we are passing a two-dimensional array, which
is contiguous and C-ordered.  We time the results and see the following:</p>

<pre><code>In [1]: import numpy as np

In [2]: from memview_bench_v3 import pairwise

In [3]: X = np.random.random((500, 3))

In [4]: timeit pairwise(X)
10 loops, best of 3: 22 ms per loop
</code></pre>

<p>This gives another factor of 30 improvement over the previous version, simply
by switching to typed memoryviews rather than the numpy interface.  Still,
our function is creating memoryview objects each time we slice the array.  We
can determine how much overhead this is generating by using raw C pointers
instead.  It is not as clean, but it should be very fast:</p>

<h3>Raw Pointers</h3>

<p>The fundamental benchmark for this sort of operation should be working
directly with the pointers themselves.  While this is not a very &#8220;pythonic&#8221;
way of doing things, it does lead to very fast code, as we will see:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='cython'><span class='line'><span class="c"># memview_bench_v4.pyx</span>
</span><span class='line'><span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span class='line'>
</span><span class='line'><span class="k">cimport</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span class='line'><span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">sqrt</span>
</span><span class='line'><span class="k">cimport</span> <span class="nn">cython</span>
</span><span class='line'>
</span><span class='line'><span class="c"># define a function pointer to a metric</span>
</span><span class='line'><span class="k">ctypedef</span> <span class="n">double</span> <span class="p">(</span><span class="o">*</span><span class="n">metric_ptr</span><span class="p">)(</span><span class="n">double</span><span class="o">*</span><span class="p">,</span> <span class="n">double</span><span class="o">*</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="k">cdef</span> <span class="kt">double</span> <span class="nf">euclidean_distance</span><span class="p">(</span><span class="n">double</span><span class="o">*</span> <span class="n">x1</span><span class="p">,</span>
</span><span class='line'>                               <span class="n">double</span><span class="o">*</span> <span class="n">x2</span><span class="p">,</span>
</span><span class='line'>                               <span class="nb">int</span> <span class="n">N</span><span class="p">):</span>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">tmp</span><span class="p">,</span> <span class="nf">d</span>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">intp_t</span> <span class="nf">i</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">d</span> <span class="o">=</span> <span class="mf">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
</span><span class='line'>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">x2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span class='line'>        <span class="n">d</span> <span class="o">+=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">tmp</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">pairwise</span><span class="p">(</span><span class="n">double</span><span class="p">[:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">X</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span>
</span><span class='line'>             <span class="n">metric</span> <span class="o">=</span> <span class="s">&#39;euclidean&#39;</span><span class="p">):</span>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">metric_ptr</span> <span class="nf">dist_func</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s">&#39;euclidean&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">dist_func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">euclidean_distance</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;unrecognized metric&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">intp_t</span> <span class="nf">i</span><span class="p">,</span> <span class="nf">j</span><span class="p">,</span> <span class="nf">n_samples</span><span class="p">,</span> <span class="nf">n_dim</span>
</span><span class='line'>    <span class="n">n_samples</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
</span><span class='line'>    <span class="n">n_dim</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">double</span>[<span class="p">:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">double</span>* <span class="nf">Dptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">D</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span> <span class="mf">0</span><span class="p">]</span>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">double</span>* <span class="nf">Xptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span> <span class="mf">0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
</span><span class='line'>            <span class="n">Dptr</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n_samples</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist_func</span><span class="p">(</span><span class="n">Xptr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">n_dim</span><span class="p">,</span>
</span><span class='line'>                                                <span class="n">Xptr</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="n">n_dim</span><span class="p">,</span>
</span><span class='line'>                                                <span class="n">n_dim</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">D</span>
</span></code></pre></td></tr></table></div></figure>


<p>Instead of passing around slices of arrays, we&#8217;ve accessed the raw memory
buffer using C pointer syntax.  This is not as easy to read, and can lead
to <code>glibc</code> errors or segmentation faults if we&#8217;re not careful.  Testing
this implementation, we find that it is extremely fast:</p>

<pre><code>In [1]: import numpy as np

In [2]: from memview_bench_v4 import pairwise

In [3]: X = np.random.random((500, 3))

In [4]: timeit pairwise(X)
100 loops, best of 3: 2.47 ms per loop
</code></pre>

<p>This is another factor of 10 faster than the memoryview benchmark above!
Essentially, what this is telling us is that creating a memoryview slice
takes about 0.02 / 500,000 = 40 nanoseconds on our machine.  This is extremely
fast, but because we&#8217;re performing this operation half a million times, the
cost of the allocations is significant compared to the rest of our
computation.  If our vectors were, say, length 1000, this cost may not be
a significant percentage of the total cost.</p>

<p>So what are we left with?  Do we need to use raw pointers in all circumstances
when working with collections of small vectors?  Perhaps not.</p>

<h3>A Faster Implementation with Memoryviews</h3>

<p>The creation of memoryview slices, though extremely fast, is causing a problem
simply because we&#8217;re creating so many slices.  Here is an alternative which
uses no raw pointers, but matches the speed of raw pointers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='cython'><span class='line'><span class="c"># memview_bench_v5.pyx</span>
</span><span class='line'><span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span class='line'>
</span><span class='line'><span class="k">cimport</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span class='line'><span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">sqrt</span>
</span><span class='line'><span class="k">cimport</span> <span class="nn">cython</span>
</span><span class='line'>
</span><span class='line'><span class="c"># define a function pointer to a metric</span>
</span><span class='line'><span class="k">ctypedef</span> <span class="n">double</span> <span class="p">(</span><span class="o">*</span><span class="n">metric_ptr</span><span class="p">)(</span><span class="n">double</span><span class="p">[:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">intp_t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">intp_t</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="k">cdef</span> <span class="kt">double</span> <span class="nf">euclidean_distance</span><span class="p">(</span><span class="n">double</span><span class="p">[:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">X</span><span class="p">,</span>
</span><span class='line'>                               <span class="n">np</span><span class="o">.</span><span class="n">intp_t</span> <span class="n">i1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">intp_t</span> <span class="n">i2</span><span class="p">):</span>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">tmp</span><span class="p">,</span> <span class="nf">d</span>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">intp_t</span> <span class="nf">j</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">d</span> <span class="o">=</span> <span class="mf">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]):</span>
</span><span class='line'>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
</span><span class='line'>        <span class="n">d</span> <span class="o">+=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">tmp</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">pairwise</span><span class="p">(</span><span class="n">double</span><span class="p">[:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">X</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span>
</span><span class='line'>             <span class="n">metric</span> <span class="o">=</span> <span class="s">&#39;euclidean&#39;</span><span class="p">):</span>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">metric_ptr</span> <span class="nf">dist_func</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s">&#39;euclidean&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">dist_func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">euclidean_distance</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;unrecognized metric&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">intp_t</span> <span class="nf">i</span><span class="p">,</span> <span class="nf">j</span><span class="p">,</span> <span class="nf">n_samples</span><span class="p">,</span> <span class="nf">n_dim</span>
</span><span class='line'>    <span class="n">n_samples</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
</span><span class='line'>    <span class="n">n_dim</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">cdef</span> <span class="kt">double</span>[<span class="p">:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
</span><span class='line'>            <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">D</span>
</span></code></pre></td></tr></table></div></figure>


<p>Timing this implementation we find the following:</p>

<pre><code>In [1]: import numpy as np

In [2]: from memview_bench_v5 import pairwise

In [3]: X = np.random.random((500, 3))

In [4]: timeit pairwise(X)
100 loops, best of 3: 2.45 ms per loop
</code></pre>

<p>Just as fast as using raw pointers, but much cleaner and easier to read.</p>

<h3>Summary</h3>

<p>Here are the timing results we&#8217;ve seen above:</p>

<ul>
<li><strong>Python + numpy</strong>: 6510 ms</li>
<li><strong>Cython + numpy</strong>: 668 ms</li>
<li><strong>Cython + memviews (slicing)</strong>: 22 ms</li>
<li><strong>Cython + raw pointers</strong>: 2.47 ms</li>
<li><strong>Cython + memviews (no slicing)</strong>: 2.45 ms</li>
</ul>


<p>So what have we learned here?  First of all, typed memoryviews are fast.
Blazing fast.  If used correctly, they can be comparable to raw pointers,
but are much cleaner easier to debug.  For example, in the last
version, if we ran into a memory error we could simply turn on bounds-checking
and quickly find the source of the problem.  Slicing with memoryviews is
also fast, but should be used carefully if your operation time on each slice
is compararable to the cost of building the slice.</p>

<p>The moral of the story?  <em>Use typed memoryviews.</em>  It will lead to fast cython
code which is cleaner, more readable, and more easily debuggable than any other
alternative.</p>

<p><strong>Update</strong>: All of the above scripts are now available as an ipython
notebook: <a href="http://jakevdp.github.com/downloads/notebooks/memview_bench.ipynb">memview_bench.ipynb</a>.
For information on how to view this file, see the
<a href="http://ipython.org/ipython-doc/dev/interactive/htmlnotebook.html">IPython page</a>
Alternatively, you can view this notebook (but not modify it) using the
nbviewer <a href="http://nbviewer.ipython.org/url/jakevdp.github.com/downloads/notebooks/memview_bench.ipynb">here</a>.</p>

<p>Thanks to Dave for the tip.</p>
]]></content>
  </entry>
  
</feed>
